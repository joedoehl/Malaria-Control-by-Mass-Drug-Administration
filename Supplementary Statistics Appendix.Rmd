---
title: 'Supplementary Statistical Appendix for: Malaria Control by Mass Drug Administration
  with Artemisinin plus Piperaquine on Grande Comore Island, Union of Comoros'
author: "Johannes S. P. Doehl"
# date: "12-6-2022"
output: 
  bookdown::pdf_document2: 
    citation_package: biblatex
    toc: FALSE
    number_sections: true
bibliography: Bibliography-BIB.bib.txt
biblio-syle: frontiers-in-immunology
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(java.parameters = "-Xmx200000m")

# Loaded Libraries
library(xlsx) 
library(Hmisc) # Required for the graph for the proportional odds ratio analysis 
library(janitor) # 
library(MASS) # required for glm.nb() function for negative binomial regression
library(glmmTMB) # required for generalized Poisson function glmmTBM(, family = genpois)
library(broom.helpers) # required for tiy_paramter() function
library(jtools) # Required for glance() function from Broom package
library(broom.mixed) # required for glance() version that works with glmmTBM files
library(MuMIn) # Required for r.squaredLR() function
library(performance) # Required for check_zeroinflation() function
library(pscl) # Required for zeroinfl() fucntion
library(data.table)
library(emmeans) # Required for emmeans() function
library(magrittr) # Contains useful function for pipe script
library(AER) # Required for the dispersiontest() function
library(stringr) # Required for str_to_title() function
library(tidyverse)
library(ggpubr) # Required for additional ggplot options
library(rmarkdown) # Adds functionalitiesto Rmarkdown
library(bookdown) # Required for including citations
library(tinytex) # Required for pdf conversion
```

```{r Called-functions, echo = FALSE, include = FALSE}
# Reads in Data from all sheets at once + manipulation to extract only relevant data
read_all1 <- function(filename, tibble = TRUE) {
    # If tibble is preferred over Data.frame use "tibble = TRUE"
    sheets <- readxl::excel_sheets(filename)
    x <- lapply(sheets, function(X) readxl::read_excel(filename, sheet = X) %>%
                  janitor::row_to_names(., row_number = 1) %>%
                  slice(., 1:(n() - 1)) %>%
                  mutate(., "District" = rep(sub("\\ .*", "", X), nrow(.))) %>%
                  mutate_at(c("Total", "Male", "Female"), as.numeric) %>%
                  mutate_at(c("District", "Age"), as.factor)
                )
    if(!tibble) x <- lapply(x, as.data.frame)
    names(x) <- sapply(sheets, function(Z) sub("\\ .*", "", Z), USE.NAMES = FALSE)
    x
}

# Reads in Data from all sheets at once + manipulation to extract only relevant data
read_all2 <- function(filename, tibble = TRUE) {
    # If tibble is preferred over data.frame use "tibble = TRUE"
    sheets <- readxl::excel_sheets(filename)
    x <- lapply(sheets, function(X) readxl::read_excel(filename, sheet = X))
    if(!tibble) x <- lapply(x, as.data.frame)
    names(x) <- sheets
    x
}

# zipFastener for TWO dataframes of unequal length
zipFastener <- function(df1, df2, along=2)
{
    # parameter checking
    if(!is.element(along, c(1,2))){
        stop("along must be 1 or 2 for rows and columns
                                              respectively")
    }
    # if merged by using zip feeding along the columns, the
    # same no. of rows is required and vice versa
    if(along==1 & (ncol(df1)!= ncol(df2))) {
        stop ("the no. of columns has to be equal to merge
               them by zip feeding")
    }
    if(along==2 & (nrow(df1)!= nrow(df2))) {
        stop ("the no. of rows has to be equal to merge them by
               zip feeding")
    }

    # zip fastener preperations
    d1 <- dim(df1)[along]
    d2 <- dim(df2)[along]
    i1 <- 1:d1           # index vector 1
    i2 <- 1:d2 + d1      # index vector 2

    # set biggest dimension dMax
    if(d1==d2) {
        dMax <- d1
    } else if (d1 > d2) {
        length(i2) <- length(i1)    # make vectors same length, 
        dMax <- d1                  # fill blanks with NAs   
    } else  if(d1 < d2){
        length(i1) <- length(i2)    # make vectors same length,
        dMax <- d2                  # fill blanks with NAs   
    }
    
    # zip fastener operations
    index <- as.vector(matrix(c(i1, i2), ncol=dMax, byrow=T))
    index <- index[!is.na(index)]         # remove NAs
    
    if(along==1){
        colnames(df2) <- colnames(df1)   # keep 1st colnames                  
        res <- rbind(df1,df2)[ index, ]  # reorder data frame
    }
    if(along==2) res <- cbind(df1,df2)[ , index]           

    return(res)
}

# Required for glmTable() function below (Micahel Fay)
`write.p` <- function(p, digits = 3, XML = FALSE) {
  p <- formatC(p, digits = digits, format = 'f')
  pout <- paste("p=", as.character(p), sep = "")
  if (XML){ 
    pout[as.numeric(p) == 0] <- paste("p &lt;.", paste(rep("0", digits-1), collapse = ""), "1", sep = "")
  } else {
    pout[as.numeric(p) == 0] <- paste("p<.", paste(rep("0", digits-1), collapse = ""), "1", sep = "")
  }
    pout
}

# Produces output table (Michael Fay)
glmTable <- function(gout) {
  s <- summary(gout)$coef
  est <- exp(s[,"Estimate"])
  #pval<-s[,"Pr(>|t|)"]
  pval <- s[,4]
  ci <- exp(confint(gout))
  lower <- ci[,1]
  upper <- ci[,2]
  out <- data.frame(Estimate = round(est,5), lower95pctCL = round(lower,5), upper95pctCL = round(upper,5), p.value = write.p(pval,5))
  out <- list(dispersion = summary(gout)$dispersion, table = out)
  out
}

vglmTable <- function(gout) {
  s <- head(tidy_parameters(gout)[, c("term", "estimate", "std.error", "statistic", "p.value")], -1) %>% 
    column_to_rownames("term") %>% 
    setNames(c("Estimate", "Std. Error", "z value", "Pr(>|z|)"))
  est <- exp(s[,"Estimate"])
  #pval<-s[,"Pr(>|t|)"]
  pval <- s[,4]
  ci <- exp(confint(gout))
  lower <- ci[,1]
  upper <- ci[,2]
  out <- data.frame(Estimate = round(est,5), lower95pctCL = round(lower,5), upper95pctCL = round(upper,5), p.value = write.p(pval,5))
  out <- list(dispersion = summary(gout)$sigma, table = out)
  out
}

# Produces a contrast analysis of AP verses AP.PMQ outcome (Michael Fay)
Contrasts <- function(C, gout, df = Inf,dig = 5){
    b <- matrix(gout$coefficients, ncol = 1)
    V <- vcov(gout)
    Cb <- C %*% b
    varCb <- C %*% V %*% t(C)
    Z <- Cb/sqrt(varCb)
    out <- data.frame(estimate = round(exp(Cb), dig),
                    lower = round(exp(Cb - qnorm(.975) * sqrt(varCb)), dig),
                    upper = round(exp(Cb + qnorm(.975) * sqrt(varCb)), dig),
                    p.value = write.p(2 * (1 - pt(abs(Z), df = df)), dig),
                    f125 = varCb / ((log(1.25) - Cb) / qnorm(.975))^2,
                    f80 = varCb / ((-log(.8) + Cb) / qnorm(.975))^2, 
                    Cb = Cb, 
                    varCb = varCb)
    out
}

# Function for crudeIncidence rates (Michael Fay)
crudeIncidence<-function(pred,Districts,PrePost){
  ndist <- length(Districts)
  pops <- rep(NA,ndist)
  for (j in 1:ndist) {
    pops[j] <- Pops[Pops$District == Districts[j], "Population"]
  }
  w <- pops / sum(pops)
  avgmonthRate <- rep(NA,ndist)
  for (j in 1:ndist) {
    x <- pred[pred$District == Districts[j] & pred$Pre_Post == PrePost, "Cases"]
    avgmonthRate[j] <- mean(x / pops[j])
  }
  10^5 * sum(w*avgmonthRate)
}
```

# Summary {-}

This appendix provides a comprehensive summary of the statistical analyses done on the demographics and malaria incidence data of Grande Comore Island. In section 1, we explore the demographics of Grande Comore Island, looking at gender and age categories distributions by district and treatment group to assess if districts are properly matched. In Section 2, we first undertake a model selection for the incidence data, which is followed by the analysis of malaria incidence rates by the selected model. In section 3, we use the same model to compare outcomes of our two-dose MDA on Grande Comore Island to the three-dose MDA on Anjouan Island from our previously published study.

# Demographic analysis of Grande Comore Island, Union of Comoros

```{r Read-in-data, echo = FALSE, include = FALSE}
Dat <- read_all1("2022-10-07 Grande Comore Districts demographic data.xlsx") # Reads in Raw Data from excel spreadsheet

# Rearranged all data into a single data frame
Dat1 <- bind_rows(lapply(Dat, function(y) {
  rowsum(y[c("Male", "Female")], as.integer(gl(nrow(y), 2, nrow(y)))) %>% # This row sums up every two rows to create values by decade of age rather than every 5 years
    mutate("District" = rep(unique(y$District), nrow(.))) %>%
    mutate("Age" = as.factor(sapply(seq(1, 16, 2), function(x) {
      paste0(sub("-.*.", "", y$Age[x]), "-", sub(".*.-", "", y$Age[x+1]))
      }) %>%
        c(., tail(as.character(y$Age), 1))))
  })) %>%
  mutate(Treatment = as.factor(if_else(District %in% c("CENTRE", "HAMBOU", "HAMAHAMET", "OICHILI"), "AP", "AP+PMQ"))) %>%
  pivot_longer(c(Male, Female), names_to = "Sex", values_to = "Population") %>%
  mutate_at("Sex", as.factor) 

Dat1 <- Dat1 %>%
  mutate(`Total Dis. Pop.` = unlist(sapply(names(Dat), function(x) Dat1 %>% filter(District == x) %>% summarise(across("Population", ~ sum(.))) %>% rep(., Dat1 %>% filter(District == x) %>% nrow(.)), simplify = FALSE)))

#Produces summary table for basice demographics by sex and district
PopBySex <- sapply(names(Dat), function(x) Dat1 %>% filter(District == x) %>% 
                     aggregate(Population ~ Sex, ., sum), simplify = FALSE) %>% 
            sapply(., function(y) y %>% 
                     remove_rownames %>% 
                     column_to_rownames(var = "Sex"), simplify = FALSE) %>% 
            bind_cols(.) %>% 
            setNames(., paste(names(Dat), "- Populaiton")) %>% 
            zipFastener(., (round(. * 100 / (as.data.frame(rbind(colSums(.))) %>% 
                                                      slice(rep(1:n(), each = 2))), 1) %>% 
                                                      setnames(., paste(names(Dat), rep("(% Pop.)", length(Dat))))), 
                        along = 2)

# Converts count data into a catgorical data set
Dat2 <- Dat1[rep(row.names(Dat1), Dat1$Population), colnames(Dat1[, !names(Dat1) %in% "Population"])]
```

In this study, mass drug administration (MDA) consisting of two rounds of either artemisinin-piperaquine (AP) only or AP + low dose primaquine (AP+PMQ~LD~) was administered to the regionally limited population of Grande Comore Island, Union of Comoros, in the efforts of malaria elimination. According to the pre-MDA survey, Grande Comore Island has a total population of `r formatC(sum(Dat1$Population), format="d", big.mark=",")` and in seven districts (`r str_to_title(paste0(sort(levels(Dat1$District)), collapse = ", "))`), of which Centre contains the capital and `r round(sum(Dat1[which(Dat1$District == "CENTRE"),]$Population) * 100 / sum(Dat1$Population), 2)`% of the island's population (`r formatC(sum(Dat1[which(Dat1$District == "CENTRE"),]$Population), format="d", big.mark=",")`). Whole districts were assigned to one of the two treatment groups: Centre, Hamahamet, Hambou, and Oichili to AP treatment and Mbadjini-Est, Mbadjini-Ouest, and Mitsamiouli to AP+PMQ~LD~ treatment. To establish statistically valid comparability between the two treatment groups, we assessed the population distribution by regression analysis, looking at population gender and age distribution by i) district, and ii) treatment group, using binomial regression and ordinal regression, respectively.

## Analysis of gender ratio Grande Comore Island, Union of Comoros

```{r Sex-Ratio-analysis-by-District, echo = FALSE, include = FALSE}
# As CENTRE is standing apart from the other six districts due to the presence of the capital and the 10 fold larger population, we choose abittrrarily another reference
Dat3 <- within(Dat2, District <- relevel(District, ref = "HAMBOU"))

# # Binomial regression for sex ratios
LinMod1 <- glm(Sex ~ District * Age, family = "binomial", data = Dat3) # This model requires an interaction term between District and Age indicated "*" otherwise the results do not make sense
summod1 <- summary(LinMod1)

# This allows a look at the estimate marginal means to give an indication of how close to 50:50 ratio of male and female inhabitants there are in each district and how that relates to one another
mod1 <- emmeans(LinMod1, "District", by = "Age")
emmmod1 <- summary(mod1, type = "response") # The "prob" data is what is used for Fig.1A
con1 <- contrast(mod1, "pairwise", type = "response")
sumcon1 <- summary(con1, infer = c(TRUE, TRUE))
```

In a first step, we used a binomial logistic regression approach to model the gender distribution of Grande Comore Island, Union of Comoros, controlling for age and either districts or treatment group. Here, we applied the glm() function (family = binomial) from the stats package in R to perform a regression analysis, acknowledging the interaction between district/treatment group populations and Age category: 

$$
glm(Sex \sim District \cdot Age, family = "binomial", data = data))
$$ 

Since the district of Centre had a special status, significant demographic differences were anticipated due to a large N (`r formatC(sum(Dat1[which(Dat1$District == "CENTRE"),]$Population), format="d", big.mark=",")` people) and unique socio-economic conditions due to the presence of the capital. Thus, we arbitrarily selected one of the other six districts (here, Hambou) as the model reference, anticipating better matching to the other 5 districts. Looking at the interaction terms of districts by age categories, it was apparent that gender distributions in Centre deviated significantly from those in Hambou for each age category following age 30-39 (p<0.001) except age 50-59, while all other districts were comparable to the gender distributions observed in Hambou.

```{r Included-Output-1, echo = FALSE, include = TRUE}
summary(LinMod1)
```

We further examined the estimated marginal means with the emmeans() function from the emmeans package in R to produced estimated probabilities (prob), comparing districts/treatment groups by age category. The estimated probabilities (prob) indicated the proportions of the male gender in each Age categories by District, where 0.5 was equivalent to 50% male population, while the female gender served as the model reference. These estimated probabilities (prob) were plotted with their respective 95% confidence intervals (Fig. 1A). Apart from Centre, all other districts followed a similar trend in gender distribution that trended toward more women with the progression of age, while maintaining a male gender ratio of `r emmmod1 %>% .[which(.$District != "CENTRE"), ] %>% arrange(prob) %>% head(., 1) %>% .$prob %>% multiply_by(100) %>% round(., 2)`% - `r emmmod1 %>% .[which(.$District != "CENTRE"), ] %>% arrange(prob) %>% tail(., 1) %>% .$prob %>% multiply_by(100) %>% round(., 2)`%. Centre, on the other hand, showed a pronounced skew toward a significantly larger proportion of the male gender in the age range 20-49 years, peaking at `r emmmod1 %>% .[which(.$District == "CENTRE"), ] %>% arrange(prob) %>% .$prob %>% tail(., 1) %>% multiply_by(100) %>% round(., 2)`% in the `r emmmod1 %>% .[which(.$District == "CENTRE"), ] %>% arrange(prob) %>% .$Age %>% tail(., 1)` age category, which could be explained by work migration of young men to the city, where job-opportunities were better. This skew then reversed in the older age categories, so that from the age >60 years, women were highly dominant with the male gender representing only `r emmmod1 %>% .[which(.$District == "CENTRE" & .$Age %in% c("60-69", "70-79" ,"80+")), ] %>% arrange(prob) %>% .$prob %>% head(., 1) %>% multiply_by(100) %>% round(., 2)`% - `r emmmod1 %>% .[which(.$District == "CENTRE" & .$Age %in% c("60-69", "70-79" ,"80+")), ] %>% arrange(prob) %>% .$prob %>% tail(., 1) %>% multiply_by(100) %>% round(., 2)`% of these age category populations. This reversed skewing may be explained by the tendency to greater longevity of women in areas of good hygiene and access to medical facilities. On the other hand, men at retirement age may opt to leave the city for the more attractive and affordable life-style in the rural parts of Grande Comore Island or other islands of the Union of Comoros.

![Shows gender distribution by age category comparing between districts and treatment groups of Grande Comore Islande, Union of Comoros, respectively. A) shows the gender distribution by age category for each of the seven districts of Grande Comore Island, Union of Comoros. B) and C) show the gender distribution by age category for the two established treatment groups with and without the district of "Centre" contained within the AP treatment group. 0.5 indicates that 50% of the population for each age category in the respective districts/treatment groups are male; thus, the remainder are female.](Image for Appendix/Sex Ratios.jpg){height=85%, width=85%}

A pairwise comparison of districts by age category rendered many cases of statistical significance. However, much of this could be attributed to the great level of precision due to the large data set (N = `r formatC(sum(Dat1$Population), format="d", big.mark=",")`), which resulted in very tight 95% confidence intervals, rather than being truly meaningful. Except for comparisons to Centre, odds ratios were confined between ~`r sumcon1[!(sumcon1$contrast %like% "CENTRE"),] %>% arrange(odds.ratio) %>% .[, "odds.ratio"] %>% head(., 1) %>% round(., 2)` and ~`r sumcon1[!(sumcon1$contrast %like% "CENTRE"),] %>% arrange(odds.ratio) %>% .[, "odds.ratio"] %>% tail(., 1) %>% round(., 2)`, indicating only minor difference in the respective gender distributions.

```{r Sex-Ratio-analysis-by-Treatment-Group-(including-CENTRE), echo = FALSE, include = FALSE}
# Binomial regression for sex ratios
LinMod2 <- glm(Sex ~ Treatment * Age, family = "binomial", data = Dat2) # This model requires an interaction term between District and Age indicated "*" otherwise the results do not make sense
summod2 <- summary(LinMod2)

# This allows a look at the estimate marginal means to give an indication of how close to 50:50 ratio of male and female inhabitants there are in each district and how that relates to one another
mod2 <- emmeans(LinMod2, "Treatment", by = "Age")
emmmod2 <- summary(mod2, type = "response") # The "prob" data is what is used for Fig.1B
con2 <- contrast(mod2, "pairwise", type = "response")
consum2 <- summary(con2, infer = c(TRUE, TRUE))
```

This analysis was repeated, substituting District with Treatment group (AP vs AP+PMQ~LD~). The inclusion of Centre in the AP treatment group resulted in statistically significant differences in gender distribution in age categories 20-29 (p<`r as.data.frame(summod2$coefficients) %>% .[rownames(.) %like% "AP+" & rownames(.) %like% "20-", ] %>% .[,"Pr(>|z|)"] %>% ifelse(. < 0.0001, 0.0001, .) %>% format(., scientific = FALSE)`), 30-39 (p<`r as.data.frame(summod2$coefficients) %>% .[rownames(.) %like% "AP+" & rownames(.) %like% "30-", ] %>% .[,"Pr(>|z|)"] %>% ifelse(. < 0.0001, 0.0001, .) %>% format(., scientific = FALSE)`), 40-49 (p<`r as.data.frame(summod2$coefficients) %>% .[rownames(.) %like% "AP+" & rownames(.) %like% "40-", ] %>% .[,"Pr(>|z|)"] %>% ifelse(. < 0.0001, 0.0001, .) %>% format(., scientific = FALSE)`), 60-69 (p<`r as.data.frame(summod2$coefficients) %>% .[rownames(.) %like% "AP+" & rownames(.) %like% "60-", ] %>% .[,"Pr(>|z|)"] %>% ifelse(. < 0.0001, 0.0001, .) %>% format(., scientific = FALSE)`), 70-79 (p<`r as.data.frame(summod2$coefficients) %>% .[rownames(.) %like% "AP+" & rownames(.) %like% "70-", ] %>% .[,"Pr(>|z|)"] %>% ifelse(. < 0.0001, 0.0001, .) %>% format(., scientific = FALSE)`), and 80+ (p<`r as.data.frame(summod2$coefficients) %>% .[rownames(.) %like% "AP+" & rownames(.) %like% "80+", ] %>% .[,"Pr(>|z|)"] %>% ifelse(. < 0.0001, 0.0001, .) %>% format(., scientific = FALSE)`) compared to the AP+PMQ~LD~ treament group. In particular, the age category 30-39 years showed a `r emmmod2 %>% .[which(.$Treatment != "AP+PMQ"), ] %>% .[.$Age %like% "30-", ] %>% .$prob %>% multiply_by(100) %>% round(., 2)`% male gender ration for the AP treatment group compared to `r emmmod2 %>% .[which(.$Treatment == "AP+PMQ"), ] %>% .[.$Age %like% "30-", ] %>% .$prob %>% multiply_by(100) %>% round(., 2)`% for the AP+PMQ~LD~ treatment groups. Conversely, the age categories 60-69, 70-79, and 80+ years in the AP treatment group showed only `r emmmod2 %>% .[which(.$Treatment != "AP+PMQ"), ] %>% .[.$Age %like% "60-", ] %>% .$prob %>% multiply_by(100) %>% round(., 2)`%, `r emmmod2 %>% .[which(.$Treatment != "AP+PMQ"), ] %>% .[.$Age %like% "70-", ] %>% .$prob %>% multiply_by(100) %>% round(., 2)`%, and `r emmmod2 %>% .[which(.$Treatment != "AP+PMQ"), ] %>% .[.$Age %like% "80+", ] %>% .$prob %>% multiply_by(100) %>% round(., 2)`% of male gender ratio compared to `r emmmod2 %>% .[which(.$Treatment == "AP+PMQ"), ] %>% .[.$Age %like% "60-", ] %>% .$prob %>% multiply_by(100) %>% round(., 2)`%, `r emmmod2 %>% .[which(.$Treatment == "AP+PMQ"), ] %>% .[.$Age %like% "70-", ] %>% .$prob %>% multiply_by(100) %>% round(., 2)`%, and `r emmmod2 %>% .[which(.$Treatment == "AP+PMQ"), ] %>% .[.$Age %like% "80+", ] %>% .$prob %>% multiply_by(100) %>% round(., 2)`% for the AP+PMQ~LD~ treatment group, respectively (Fig. 1B). This outcome was expected as it reflects the previously observed skews of gender distributions in Centre. Considering that Centre made up ~`r sum(Dat1[Dat1$District %like% "CENTRE",]$Population) %>% divide_by(sum(Dat1[which(Dat1$Treatment != "AP+PMQ"),]$Population)) %>% multiply_by(100) %>% round(., 2)`% of the population in the AP treatment group, any homogenizing effect from the other three district in the AP treatment group to the gender distributions were expected to be limited. 

```{r Included-Output-2, echo = FALSE, include = TRUE}
summary(LinMod2)
```

Excluding Centre from the AP treatment group showed no significant difference for the interaction of Age and treatment group to explain gender ratios, suggesting that exclusion of Centre resulted in more balanced and comparable demographics with respect to gender distribution between the AP and AP+PMQ~LD~ treatment groups (Fig. 1C).

## Analysis of population distribution by age category

```{r Sex-Ratio-analysis-by-Treatment-Group-(excluding-CENTRE), echo = FALSE, include = FALSE}
# Exclude CENTRE from the analysis
Dat4 <- Dat2[which(Dat2$District != "CENTRE"), ] %>% mutate_at("District", as.character) %>% mutate_at("District", as.factor)

# Binomial regression for sex ratios
LinMod3 <- glm(Sex ~ Treatment * Age, family = "binomial", data = Dat4) # This model requires an interaction term between District and Age indicated "*" otherwise the results do not make sense
summary(LinMod3)

# This allows a look at the estimate marginal means to give an indication of how close to 50:50 ratio of male and female inhabitants there are in each district and how that relates to one another
mod3 <- emmeans(LinMod3, c("Age", "Treatment"))
summary(mod3, type = "response", by = "Age") ## The "prob" data is what is used for Fig.1C
con3 <- contrast(mod3, "pairwise", type = "response")
summary(con3, infer = c(TRUE, TRUE))
```
```{r Included-Output-3, echo = FALSE, include = TRUE}
summary(LinMod3)
```

```{r Ordinal-regression-by-Age-against-District, echo = FALSE, include = FALSE, eval = TRUE}
# # Ordinal regresison of Age as dependent variable with district as predictor
LinMod4 <- polr(formula = Age ~ District, data = Dat3, Hess = TRUE)
ctable4 <- coef(summary(LinMod4))
ctable4 <- cbind(ctable4, "p-value" = round(pnorm(abs(ctable4[, "t value"]), lower.tail = FALSE) * 2, 4))
OR4 <- exp(cbind(OR = coef(LinMod4), as.data.frame(confint(LinMod4)))) # This is the best output format for interpreation of coefficience as they are shown as proportional odds ratios
```

In a second step, we simplified the analysis by examining if the population distribution by age category irrespective of gender was comparable between districts. Acknowledging the obvious chronological order of the age categories that now served as a dependent variable, we applied an ordinal regression with Districts as our main effect, making use of the polr() function from the MASS package in R:

$$
polr(formula = Age \sim District, data = data, Hess = TRUE)
$$

Due to the much larger population of Centre and its distinct distribution of gender ratios, statistically significant differences with Centre were expected, which was confirmed in the analysis (p<`r ctable4[rownames(ctable4) %like% "CENTRE", "p-value"] %>% ifelse(. <0.0001, 0.0001, .) %>% format(., scientific = FALSE)`). It is of note that the districts of Mitsamiouli, Mbadjini-Ouest, and Mbadjini-Est (the AP+PMQ~LD~ treatment group) also showed statistically significant differences to the reference district of Hambou (p=`r ctable4[rownames(ctable4) %like% "MITSAMIOULI", "p-value"] %>% ifelse(. <0.0001, 0.0001, .)`, p=`r ctable4[rownames(ctable4) %like% "MBADJINI-OUEST", "p-value"] %>% ifelse(. <0.0001, 0.0001, .)`, p=`r ctable4[rownames(ctable4) %like% "MBADJINI-EST", "p-value"] %>% ifelse(. <0.0001, 0.0001, .)`, respectively), while the districts of Hamahamet and Oichili (all part of the AP treatment group) did not.

```{r Included-Output-4-1, echo = FALSE, include = TRUE}
# Best output format for the Ordinal regression analysis (Odds Ratios)
print(ctable4[rownames(ctable4) %like% "District", , drop = FALSE])
```

Looking at the odds ratios, however, we saw only comparatively small deviations from Hambou (model reference). The statistical significances thus reflected tight 95% confidence intervals due to the large data N and great data precision that excluded 1 for all districts, but Hamahamet and Oichili. The biggest deviation from 1 was by Centre, which was the only district showing odds ratios >1 compared to Hambou.

```{r Included-Output-4-2, echo = FALSE, include = TRUE}
# Best output format for the Ordinal regression analysis (Odds Ratios)
print(OR4)
```

To ensure that the ordinal regression model was valid, we had to verify the assumption of proportional odds ratios. While available statistical tests for testing this assumption were considered prone to reject the null-hypothesis and were poorly defined in R, Frank E. Harrell suggested a graphical approach in examining the assumption validity, which we applied here (Fig. 2) [@Harrell2016]. In essence, the assumption was tenable, if the proportional odds ratios were the same for all districts for a particular cutpoint in the dependent variable (Age). This meant that all proportional odds ratios should be aligned vertically for all districts for a particular cutpoint in a graph. As can be seen in Figure 2, Centre did not align with other districts in many places, suggesting that the change in population ratio from one age category to the next was different for Centre compared to all other districts. This meant, the proportional odds ratio assumption was violated and results from the ordinal regression had to be considered with caution.

```{r Prop-odds-4, echo = FALSE, include = FALSE}
# Check proportional odds assumption
sf <- function(y) { # This is the function that generates the table below
    c('Y>=1' = qlogis(mean(y >= 1)),
      'Y>=2' = qlogis(mean(y >= 2)),
      'Y>=3' = qlogis(mean(y >= 3)),
      'Y>=4' = qlogis(mean(y >= 4)),
      'Y>=5' = qlogis(mean(y >= 5)),
      'Y>=6' = qlogis(mean(y >= 6)),
      'Y>=7' = qlogis(mean(y >= 7)),
      'Y>=8' = qlogis(mean(y >= 8)),
      'Y>=9' = qlogis(mean(y >= 9)))
}

# Check proportional odds assumption
s <- with(Dat2, summary(as.numeric(Age) ~ District, fun=sf))

# # This regressions only serve as a verification tool for the output of the aboth formula and are not further relevant
# glm(I(as.numeric(Age) >= 2) ~ District, family="binomial", data = Dat2)
# glm(I(as.numeric(Age) >= 3) ~ District, family="binomial", data = Dat2)
# glm(I(as.numeric(Age) >= 4) ~ District, family="binomial", data = Dat2)
# glm(I(as.numeric(Age) >= 5) ~ District, family="binomial", data = Dat2)
# glm(I(as.numeric(Age) >= 6) ~ District, family="binomial", data = Dat2)
# glm(I(as.numeric(Age) >= 7) ~ District, family="binomial", data = Dat2)
# glm(I(as.numeric(Age) >= 8) ~ District, family="binomial", data = Dat2)
# glm(I(as.numeric(Age) >= 9) ~ District, family="binomial", data = Dat2)

# This array of formulas normalizes the data by setting Y>=2 to zero by subtracting that column from all others
s[, 10] <- s[, 10] - s[, 3]
s[, 9] <- s[, 9] - s[, 3]
s[, 8] <- s[, 8] - s[, 3]
s[, 7] <- s[, 7] - s[, 3]
s[, 6] <- s[, 6] - s[, 3]
s[, 5] <- s[, 5] - s[, 3]
s[, 4] <- s[, 4] - s[, 3]
s[, 3] <- s[, 3] - s[, 3]
```
```{r Fig-2, echo = FALSE, include = TRUE, fig.height = 5, fig.width = 7,  fig.cap = "Graphical verification of validity of proportional odds ratio assumption for ordinal regression considering Districts as independent"}
# Plots the tabled data for visual inspection whether the proportional odds assumption holds
plot(s, which=1:9, pch=1:9, xlab='logit', main=' ', xlim=range(s[,3:10])) # Hmisc required here
```

This distinct distribution of Centre's population by age category was confirmed by the graphical examination (Fig. 3). While all other districts showed a comparable slops of population decline by age category, Centre showed a significant shoulder around the age category 40-49 years and a much steeper drop toward the age category 60-69 years consistent with Centre's unique proportional odds ratios in the previous analysis.

```{r Data-rearrangment-for-plot, echo = FALSE, include = FALSE}
# Data rearrangement for a graph
Dat5 <- bind_rows(lapply(Dat, function(y) {
  rowsum(y[c("Male", "Female")], as.integer(gl(nrow(y), 2, nrow(y)))) %>% # This row sums up every two rows to create values by decade of age rather than every 5 years
    mutate("Total" = (.$Male + .$Female)) %>%
    mutate("District" = rep(unique(y$District), nrow(.)), .before = Male) %>%
    mutate("Age" = as.factor(sapply(seq(1, 16, 2), function(x) {
      paste0(sub("-.*.", "", y$Age[x]), "-", sub(".*.-", "", y$Age[x+1]))
      }) %>%
        c(., tail(as.character(y$Age), 1))), .after = District)
  })) %>%
  mutate(Treatment = as.factor(if_else(District %in% c("CENTRE", "HAMBOU", "HAMAHAMET", "OICHILI"), "AP", "AP+PMQ")), .after = Age)
```
```{r Fig-3, echo = FALSE, include = TRUE, fig.height = 6, fig.width = 6,  fig.cap = "Graphical representation of total population by Age category within each District along the chronological order of age category"}
# This graph shows the change in population by age group between districts to show trends of decay
# png(filename="Total Pop by Age & Dis.jpeg", width=1200, height=1200)

ggplot(data = Dat5, aes(x = Age, y = Total, group = District)) +
  geom_line(color = 'Blue', linewidth = 1) +
  facet_grid(District ~ ., margins = FALSE, scales = "free", space = 'free_x') +
  theme(strip.text.y = element_text(angle = 0)) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1), text = element_text(size = 10))

# dev.off()
```

```{r Ordinal-regression-by-Age-against-Treatment-1, echo = FALSE, include = FALSE, eval = TRUE}
LinMod5 <- polr(formula = Age ~ Treatment, data = Dat2, Hess = TRUE)
ctable5 <- coef(summary(LinMod5))
ctable5 <- cbind(ctable5, "p-value" = round(pnorm(abs(ctable5[, "t value"]), lower.tail = FALSE) * 2, 4))
OR5 <- exp(cbind(OR = coef(LinMod5), as.data.frame(t(confint(LinMod5))))) # This is the best output format for interpreation of coefficience as they are shown as proportional odds ratios
```

Akin to the gender ratio analysis, we also ran an ordinal regression substituting districts with treatment groups to understand how the individual district demographics affected the balance in population distribution between age categories. As could be expected due to the presence of Centre in the AP treatment group, there was a statistically significant difference (p<`r ctable5[rownames(ctable5) %like% "AP+", "p-value"] %>% ifelse(. <0.0001, 0.0001, .) %>% format(., scientific = FALSE)`) between the AP and AP+PMQ~LD~ treatment groups in terms of the population distribution by age category.

```{r Included-Output-5-1, echo = FALSE, include = TRUE}
# Best output format for the Ordinal regression analysis (Odds Ratios)
print(ctable5[rownames(ctable5) %like% "AP+", , drop = FALSE] %>% as.data.frame(.) %>% mutate_at("p-value", ~ ifelse(. < 0.0001, "<0.0001", .)) %>% format(., scientific = FALSE))
```

This can also be observed in the graphical representation of the populations' decline by age categories, which reflected the observations for Centre from ordinal regression with districts. As with the gender distribution, the large population of Centre diminished the homogenization effects of the data from the other three districts in the AP group and thus, the AP group is dominated by the behavior of the population decline in Centre as observed above.

```{r Fig-4, echo = FALSE, include = TRUE, fig.height = 2.5, fig.width = 6,  fig.cap = "Graphical representation of total population by Age category within each Treatment group including Centre in the AP group along the chronological order of Age categories"}
# This graph shows the change in population by age group between districts to show trends of decay
Dat6 <- aggregate(Total ~ Age + Treatment, data = Dat5, FUN = sum)

# png(filename="Total Pop by Age & Dis.jpeg", width=1200, height=1200)
ggplot(data = Dat6, aes(x = Age, y = Total, group = Treatment)) +
  geom_line(color = 'Blue', linewidth = 1) +
  facet_grid(Treatment ~ ., margins = FALSE, scales = "free", space = 'free_x') +
  theme(strip.text.y = element_text(angle = 0)) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1), text = element_text(size = 10))

# dev.off()
```

Looking at the odds ratio (`r OR5[, "OR"] %>% round(., 2)`), it suggested that for an individual in the AP+PMQ~LD~ treatment group to be in age category other than 0-9 years was ~`r (1 - OR5[, "OR"]) %>% multiply_by(100) %>% round(., 2)`% less likely than in the AP treatment group (including Centre-s population), indicating some imbalance in the age category distribution between the two treatment areas, although not massively. 

```{r Included-Output-5-2, echo = FALSE, include = TRUE}
# Best output format for the Ordinal regression analysis (Odds Ratios)
print(OR5)
```

Analogous to the comparison of districts above, the two treatment groups also did not comply with the proportional odds assumption, stemming from the inclusion of Centre in the AP treatment group (Fig. 5).

```{r Prop-odds-5, echo = FALSE, include = FALSE}
# Check proportional odds assumption
s <- with(Dat2, summary(as.numeric(Age) ~ Treatment, fun=sf))
# 
# # This regressions only serve as a verification tool for the output of the aboth formula and are not further relevant
# glm(I(as.numeric(Age) >= 2) ~ Treatment, family="binomial", data = Dat2)
# glm(I(as.numeric(Age) >= 3) ~ Treatment, family="binomial", data = Dat2)
# glm(I(as.numeric(Age) >= 4) ~ Treatment, family="binomial", data = Dat2)
# glm(I(as.numeric(Age) >= 5) ~ Treatment, family="binomial", data = Dat2)
# glm(I(as.numeric(Age) >= 6) ~ Treatment, family="binomial", data = Dat2)
# glm(I(as.numeric(Age) >= 7) ~ Treatment, family="binomial", data = Dat2)
# glm(I(as.numeric(Age) >= 8) ~ Treatment, family="binomial", data = Dat2)
# glm(I(as.numeric(Age) >= 9) ~ Treatment, family="binomial", data = Dat2)

# This array of formulas normalizes the data by setting Y>=2 to zero by subtracting that column from all others
s[, 10] <- s[, 10] - s[, 3]
s[, 9] <- s[, 9] - s[, 3]
s[, 8] <- s[, 8] - s[, 3]
s[, 7] <- s[, 7] - s[, 3]
s[, 6] <- s[, 6] - s[, 3]
s[, 5] <- s[, 5] - s[, 3]
s[, 4] <- s[, 4] - s[, 3]
s[, 3] <- s[, 3] - s[, 3]
```
```{r Fig-5, echo = FALSE, include = TRUE, fig.height = 3.5, fig.width = 7,  fig.cap = "Graphical verification of validity of proportional odds ratio assumption for ordinal regression considering Treatment groups (including Centre) as independent"}
# Plots the tabled data for visual inspection whether the proportional odds assumption holds
plot(s, which=1:9, pch=1:9, xlab='logit', main=' ', xlim=range(s[,3:10])) # Hmisc required here
```

```{r Ordinal-regression-by-Age-against-Treatment-2, echo = FALSE, include = FALSE, eval = TRUE}
LinMod6 <- polr(formula = Age ~ Treatment, data = Dat4, Hess = TRUE)
ctable6 <- coef(summary(LinMod6))
ctable6 <- cbind(ctable6, "p-value" = round(pnorm(abs(ctable6[, "t value"]), lower.tail = FALSE) * 2, 4))
OR6 <- exp(cbind(OR = coef(LinMod6), as.data.frame(t(confint(LinMod6))))) # This is the best output format for interpreation of coefficience as they are shown as proportional odds ratios
```

Thus, we repeated the analysis excluding Centre from the AP treatment group. This resulted in a more balanced comparison, although statistically significant difference remained apparent (p=`r ctable6[rownames(ctable6) %like% "AP+", , drop = FALSE] %>% .[, "p-value"] %>% format(., scientific = FALSE)`). This was not surprising since the districts of Mitsamilouli, Mbadjini-Ouest, and Mbadjini-Est, that constituted the AP+PMQ~LD~ treatment group, had previously been shown to have statistically significant differences from the districts included in AP treatment group.

```{r Included-Output-6-1, echo = FALSE, include = TRUE}
# Best output format for the Ordinal regression analysis (Odds Ratios)
print(ctable6[rownames(ctable6) %like% "AP+", , drop = FALSE] %>% as.data.frame(.) %>% mutate_at("p-value", ~ ifelse(. < 0.0001, "<0.0001", .)) %>% format(., scientific = FALSE))
```

Looking again at the population decline along the chronology of the age categories, we can see that both treatment areas are now much better matched in terms of the trend decline, but still apart in terms of N per Age category.

```{r Fig-6, echo = FALSE, include = TRUE, fig.height = 2.5, fig.width = 6,  fig.cap = "Graphical representation of total population by Age category within each Treatment group excluding Centre in the AP group along the chronological order of Age categories"}
# This graph shows the change in population by age group between districts to show trends of decay
Dat7 <- Dat5[which(Dat5$District != "CENTRE"), ] %>%
  aggregate(Total ~ Age + Treatment, data = ., FUN = sum)

# png(filename="Total Pop by Age & Dis.jpeg", width=1200, height=1200)
ggplot(data = Dat7, aes(x = Age, y = Total, group = Treatment)) +
  geom_line(color = 'Blue', linewidth = 1) +
  facet_grid(Treatment ~ ., margins = FALSE, scales = "free", space = 'free_x') +
  theme(strip.text.y = element_text(angle = 0)) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1), text = element_text(size = 10))

# dev.off()
```

Comparing Figure 4 and Figure 6, we saw that, excluding Centre created a much better match for the population distribution by age category between both treatment groups (~`r (1 - OR6[, "OR"]) %>% multiply_by(100) %>% round(., 2)`% less likely to be in an age category other than 0-9 years, rather than ~`r (1 - OR5[, "OR"]) %>% multiply_by(100) %>% round(., 2)`% including Centre).

```{r Included-Output-6-2, echo = FALSE, include = TRUE}
# Best output format for the Ordinal regression analysis (Odds Ratios)
OR6
```

Excluding Centre from the AP treatment group also resulted in a convincing approximation to complying with the proportional odds ratio assumption as they aligned well (Fig. 7). This meant the ordinal regression was valid.

```{r Prop-odds-6, echo = FALSE, include = FALSE}
# Check proportional odds assumption
s <- with(Dat4, summary(as.numeric(Age) ~ Treatment, fun=sf))

# # This regressions only serve as a verification tool for the output of the aboth formula and are not further relevant
# glm(I(as.numeric(Age) >= 2) ~ Treatment, family="binomial", data = Dat4)
# glm(I(as.numeric(Age) >= 3) ~ Treatment, family="binomial", data = Dat4)
# glm(I(as.numeric(Age) >= 4) ~ Treatment, family="binomial", data = Dat4)
# glm(I(as.numeric(Age) >= 5) ~ Treatment, family="binomial", data = Dat4)
# glm(I(as.numeric(Age) >= 6) ~ Treatment, family="binomial", data = Dat4)
# glm(I(as.numeric(Age) >= 7) ~ Treatment, family="binomial", data = Dat4)
# glm(I(as.numeric(Age) >= 8) ~ Treatment, family="binomial", data = Dat4)
# glm(I(as.numeric(Age) >= 9) ~ Treatment, family="binomial", data = Dat4)

# This array of formulas normalizes the data by setting Y>=2 to zero by subtracting that column from all others
s[, 10] <- s[, 10] - s[, 3]
s[, 9] <- s[, 9] - s[, 3]
s[, 8] <- s[, 8] - s[, 3]
s[, 7] <- s[, 7] - s[, 3]
s[, 6] <- s[, 6] - s[, 3]
s[, 5] <- s[, 5] - s[, 3]
s[, 4] <- s[, 4] - s[, 3]
s[, 3] <- s[, 3] - s[, 3]
```
```{r Fig-7, echo = FALSE, include = TRUE, fig.height = 3.5, fig.width = 7,  fig.cap = "Graphical representation of total population by Age category within each Treatment group excluding Centre from the AP group along the chronological order of Age category"}
# Plots the tabled data for visual inspection whether the proportional odds assumption holds
plot(s, which=1:9, pch=1:9, xlab='logit', main=' ', xlim=range(s[,3:10])) # Hmisc required here
```

The conclusion from this analysis was that the districts Hamahamet, Hambou, Mbadjini-Est, Mbadjini-Ouest, Mitsamiouli, and Oichili had comparable gender ratios and approximately similar population distributions by their age categories. The district of Centre was an outlier in the demographic analysis that could affect the comparability of treatment groups in demographic distribution. Accordingly, we proceeded with comparative analyses of our MDA results from the AP+PMQ~LD~-treated and AP-treated districts, including as well as excluding the data from Centre.

# Statistical analysis of the malaria incidence data of Grande Comore Islande, Union of Comoros (2012-2017)

```{r, read-in-data-2, echo = FALSE, include = FALSE}
# Loading and manipulation of the data tables from the excel file
dat <- read_all2("Raw Incidence Data.xlsx") # Reads in Raw Data from excel spreadsheet

dat <- dat[c(1,2)] # reduced data frame list to the two main elements

dat <- dat %>% # Re-assigns variable to different formats
  lapply(., function(x) {
    as.data.frame(x) %>%
      mutate(across(where(is.character), as.factor)) %>%
      mutate(across("Year", as.factor)) %>%
      mutate(across("Date", as.Date)) %>%
      rename(., "AP.PMQ" = "AP+PMQ")
  })

dat <- lapply(dat, function(x) { # recodes years into a numeric integer
  y <- as.factor(c(1:length(levels(x$Year))) %>% setNames(levels(x$Year)) %>% recode(x$Year, !!!.))
  x %>% mutate(Year_2 = y)
})

# Extracting the incidence data from Grande Comores Island
dat0 <- dat[["Grande Comore Island"]]
```

A total of `r 12 * 6` months of malaria incidence data was collected from the 7 districts of Grande Comore Island, Union of Comoros, of which 21 months (Jan. 2012 - Sep. 2013) represented pre-treatment data. Two rounds of AP or AP+PMQ~LD~ MDA were conducted in all districts starting Oct. 2013 (dry season). Subsequently, four years of surveillance data was collected to assess effectiveness of the MDA. As can be seen from Figure 8, monthly malaria incidence jumped to high levels after onset of the wet season in 2012 and 2013 and peaked in all districts of Grande Comore Island between January and March, followed by declines toward December (Fig. 8). This pattern was broken starting 2014 after application of two round AP or AP+PMQ~LD~ MDA and incidences continued to be for low for the remainder of the study, although minor increases were observed toward the end of the study period (2017). 

```{r Fig-8, echo = FALSE, include = TRUE, fig.height = 9, fig.width = 7,  fig.cap = "Bar chart representation of monthly malaria incidence counts by district across Grande Comore Island spanning Jan. 2012 to Dec. 2017. The black dottet line marks the beginning of MDA (Oct 2013)."}
# png(filename="Case distribution.jpeg", width=1200, height=1200)
# tiff("Case distribution.tiff", units="in", width=6, height=7, res=600)

ggplot(dat0, aes(x = Date, y = Cases, fill = Year)) + 
  geom_bar(stat = "identity") + 
  facet_grid(District ~ ., margins = TRUE, scales = "free", space = 'free_x') +  
  theme(strip.text.y = element_text(angle = 0)) +
  geom_vline(xintercept = as.numeric(dat0$Date[22]), linetype=4, colour="black") +
  scale_x_date(date_breaks = "6 month", date_labels = "%b %Y") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1), text = element_text(size = 10))

# dev.off()
```

## Model fitting to the incidence data of Grande Comore Island, Union of Comoros (2012-2017)

In order to analysis the malaria incidence data comprehensively, we needed to choose a regression model that could cope with count data. The standard generalized regression models for count data analysis were the Poisson, quasi-Poisson and negative binomial models [@Fox2016]. Further, we needed to consider that districts and treatment groups were mismatched in terms of population, as seen above, which meant that we needed to offset by total population in districts and treatment groups, respectively. Achieving the offsets was equivalent to the use of incidence rates rather than incidence counts in the chosen model.   

```{r Checkin-Poisson-assumption, echo = FALSE, include = FALSE}
# Checking Poisson assumption (mean = variance)
MeanVar <- dat0 %>% group_by(District) %>% summarise(Mean = mean(Cases), Variance = var(Cases))

# Select on district to model the data to use it later as a predictor to assess model quality on other six (6) districts
dat1 <- dat0[which(dat0$District == "Hamahamet"), ]

# Poissson model Grande Comore Island
Pmod1 <- glm(formula = Cases ~ Month_1 + Year + offset(log(Population)), family = poisson(), data = dat1)
AssTst <- dispersiontest(Pmod1)
```

The Poisson model assumes that the sample mean is equal to the variance. If the variance is considerably larger than the mean, the data is overdispersed and a Poisson model is not applicable. Considering the mean and variance for each district it becomes clear that this assumption is violated (Note that variance is not standard deviation (SD) but is related: 

$$
\sqrt{s^2} = SD
$$

where s^2^ is a symbol for variance.

```{r Mean-compared-to-variance, echo = FALSE, include = TRUE}
MeanVar
```

We formally tested for overdispersion in a Poisson model by using the dispersiontest() function from the AER package in R after running the model. For this, we arbitrarily picked data for the district, Hamahamet, using Months and Years as main effects and the logged total population as an offset: 

$$
glm(formula = Cases \sim Month + Year + offset(log(Population)), family = poisson(), data = data)
$$ 

The applied dispersion test showed a value of `r round(AssTst$estimate, 2)`, which was statistically significantly different from 1 (p<`r round(AssTst$p.value, 4)`). This excluded a Poisson model from further consideration. Quasi-Poisson and negative binomial models were both appropriate for dealing with overdispersed count data. The primary difference of these two models was in their relationship between mean and variance; namely, in a quasi-Poisson model, variance is a linear function of the mean, while in a negative binomial model, variance is a quadratic function of the mean. This means that large and small values got weighted differently in these two models. Effectively, both models tend to render similar results, but on occasion, they can produce contrasting outcomes [@VerHoef2007]. Unfortunately, there was no simple way of choosing between these two models, as the quasi-Poisson model does neither produce Akaike nor Bayesian information criterions (AIC and BIC, respectively). Thus, we started by applying both of these to the incidence data to assess which one produced the better fit to the data.

```{r Regression-models-of-malaria-incidence-Hamahamet-as-preditor, echo = FALSE, include = FALSE}
# Since the Poisson assumption of mean = variance is not appropriate, we can choose between a quasi-Poisson or a negative binomial model. In the following we will assess, which may fit best

# Quasi-Poisson models Grande Comore Island
QPmod1 <- glm(formula = Cases ~ Month_1 + Year + offset(log(Population)), family = quasipoisson(), data = dat1)
summary(QPmod1)
QPtab1 <- glmTable(QPmod1)
# The PseudoR^2 tells us how much of the data variability can be explained by our model
PseudoR2_QP1 <- glance(QPmod1) %>%
  summarise(PreudoR2 = 1 - deviance / null.deviance) %>%
  cbind(., ID = "Quasi-Poisson") %>%
  set_rownames(.$ID) %>%
  select(., -ID)

# Negative binomial models Grande Comore Island
NBmod1 <- glm.nb(formula = Cases ~ Month_1 + Year + offset(log(Population)), data = dat1)
summary(NBmod1)
NBtab1 <- glmTable(NBmod1)
# The PseudoR^2 tells us how much of the data variability can be explained by our model
PseudoR2_NB1 <- glance(NBmod1) %>%
  summarise(PreudoR2 = 1 - deviance / null.deviance) %>%
  cbind(., ID = "Negative Binomial") %>%
  set_rownames(.$ID) %>%
  select(., -ID)
```

We continued with the data from the district, Hamahamet, to build the quasi-Poisson and negative binomial models using months and years as main effects and the logged total population as an offset just as we did for the Poisson model:

$$
glm(formula = Cases \sim Month + Year + offset(log(Population)), family = quasipoisson(), data = data)
$$

$$
glm.nb(formula = Cases \sim Month + Year + offset(log(Population)), data = data)
$$

Both models produced similar annual incidence rates for Hamahamet, correctly indicating comparable malaria incidence rates for 2012 and 2013 (pre-treatment years) and significantly different incidence rates for the following 4 years (post-treatment). Both models also produced high pseudoR^2^ values (QP = `r round(PseudoR2_QP1[1,1], 3)`, NB = `r round(PseudoR2_NB1[1,1], 3)`). However, the quasi-Poisson model's pseudoR^2^ was larger, thus, explaining more of the data variability.

```{r glmTables, echo = FALSE, include = TRUE}
print("Quasi-Poisson model")
QPtab1$table[rownames(QPtab1$table) %like% "Year", ]

print("Negative binomial model")
NBtab1$table[rownames(NBtab1$table) %like% "Year", ]
```

```{r Assessing-model-predictive-power, echo = FALSE, include = FALSE}
dat2 <- dat0[which(dat0$District != "Hamahamet"), ] 

# Checking Quasi-Poisson model
dat3 <- sapply(levels(droplevels(dat2$District)), function(x) {
    dat2[dat2$District %like% x, ] %>%
      mutate("Predicted" = predict(QPmod1, newdata = ., type = "response"))
  }, simplify = FALSE) %>%
  bind_rows(.)

QPpred <- ggplot(dat3, aes(x = Predicted , y = Cases, group = District)) +
  geom_point(aes(color = District), size = 1) +
  geom_smooth(method=lm, se=FALSE, aes(color = District), size = 0.5) +
  facet_wrap(District ~ ., nrow = 6, scales = "free") 

# Checking Negative Binomial model
dat4 <- sapply(levels(dat2$District), function(x) {
    dat2[dat2$District %like% x, ] %>%
      mutate("Predicted" = predict(NBmod1, newdata = ., type = "response"))
  }, simplify = FALSE) %>%
  .[names(.) != "Hamahamet"] %>%
  bind_rows(.)

NBpred <- ggplot(dat4, aes(x = Predicted , y = Cases, group = District)) +
  geom_point(aes(color = District), size = 1) +
  geom_smooth(method=lm, se=FALSE, aes(color = District), size = 0.5) +
  facet_wrap(District ~ ., nrow = 6, scales = "free") 

# This puts the prediction graphs for QP and NB together
PredObs <- ggarrange(QPpred, NBpred, labels = c("A", "B"), common.legend = TRUE, legend = "bottom")

# Calculating RMSE for residuals for both models and SD for Cases
RMSE <- cbind(
  sapply(levels(droplevels(dat3$District)), function(x) { 
  dat3[dat3$District %like% x,] %>% 
    mutate(Residuals = Predicted - Cases) %>% 
    summarise(RMSE_QP = sqrt(mean(Residuals^2)))
  }, simplify = FALSE) %>%
  bind_rows(., .id = "id") %>%
  column_to_rownames(., "id"),
  sapply(levels(droplevels(dat4$District)), function(x) { 
  dat4[dat4$District %like% x,] %>% 
    mutate(Residuals = Predicted - Cases) %>% 
    summarise(RMSE_NB = sqrt(mean(Residuals^2))) %>% 
    mutate(Cases_SD = sd(dat4[dat4$District %like% x,]$Cases))
  }, simplify = FALSE) %>%
  bind_rows(., .id = "id") %>%
  column_to_rownames(., "id")
)
```

We then moved on to assess the ability of both models to predict the incidence for the other 6 districts. For a visual inspection, we plotted predicted incidence against observed incidence and fitted a line to the correlated datasets (Fig. 9). While both models appear to predict the incidence data for the other districts similarly well, overall, the quasi-Poisson model seems to predict the incidence data more accurately.

```{r Fig-9, echo = FALSE, include = TRUE, fig.height = 8, fig.width = 5.5,  fig.cap = "Correlation of predicted verus observed incidence rates for Centre, Hambou, Mbadjini-Est, mBadjini-Ouest, and Oichili using A) the quasi-Poisson model and B) the negative binomial model primed with the actual incidence counts of Hamahamet for the predictive model"}
# This puts the prediction graphs for QP and NB together
PredObs
```

We also computed the root-mean-square-deviations from both models for each district and found that each model had large errors, indicating no substantial performance advantage of one over the other by this measure.

```{r RMSE, echo = FALSE, include = TRUE}
RMSE
```

```{r Full-models-for-incidence-distribution, echo = FALSE, include = FALSE}
# Quasi-Poisson models Grande Comore Island
QPmod2 <- glm(formula = Cases ~ District + Month_1 + Year + offset(log(Population)), family = quasipoisson(), data = dat0)
summary(QPmod2)
QPtab2 <- glmTable(QPmod2)
# The PseudoR^2 tells us how much of the data variability can be explained by our model
PseudoR2_QP2 <- glance(QPmod2) %>%
  summarise(PreudoR2 = 1 - deviance / null.deviance) %>%
  cbind(., ID = "Quasi-Poisson") %>%
  set_rownames(.$ID) %>%
  select(., -ID)

# Negative binomial models Grande Comore Island
NBmod2 <- glm.nb(formula = Cases ~ District + Month_1 + Year + offset(log(Population)), data = dat0)
summary(NBmod2)
NBtab2 <- glmTable(NBmod2)
# The PseudoR^2 tells us how much of the data variability can be explained by our model
PseudoR2_NB2 <- glance(NBmod2) %>%
  summarise(PreudoR2 = 1 - deviance / null.deviance) %>%
  cbind(., ID = "Negative Binomial") %>%
  set_rownames(.$ID) %>%
  select(., -ID)
```

We then ran both models on the full incidence data from Grande Comore Island including districts, months, and years as main model effects, while offsetting by the district populations. Here, the quasi-Poisson model produced a higher pseudoR^2^ value than the negative binomial model (QP = `r round(PseudoR2_QP2[1,1], 3)`, NB = `r round(PseudoR2_NB2[1,1], 3)`). Using each model, we calculated the predicted monthly incidences per 100,000 people for each district across the study period (2012-2017) and plotted these against the observed incidence rates per 100,000 peoples (Fig 10).

```{r Calculate-model-incidence, echo = FALSE, include = FALSE}
# Adding modelled incidence data to the data table
DatOut0 <- dat0 %>%
  mutate(ObsRatePer100000 = round(10^5 * .$Cases/.$Population, 1)) %>%
  mutate(ModelRatePer100000_QP = round(10^5 * predict(QPmod2, type = "response")/.$Population, 1)) %>%
  mutate(ModelRatePer100000_NB = round(10^5 * predict(NBmod2, type = "response")/.$Population, 1)) %>%
  mutate(Date = format(.$Date, "%b %Y")) %>%
  select(District, Date, Year, Population, Cases, ObsRatePer100000, ModelRatePer100000_QP, ModelRatePer100000_NB) %>%
  rename(., c("Observed Rates" = ObsRatePer100000, "Modelled Rates (QP)" = ModelRatePer100000_QP, "Modelled Rates (NB)" = ModelRatePer100000_NB))

# Reformating DatOut for the graph
DatOut1 <- DatOut0 %>% 
  mutate(Date = as.Date(paste("1", .$Date), format = "%d %b %Y")) %>%
  pivot_longer(., c("Observed Rates", "Modelled Rates (QP)", "Modelled Rates (NB)"), names_to = "Rate Type", values_to = "Incidence Rates / 100,000")
```

```{r Fig-10, echo = FALSE, include = TRUE, fig.height = 7, fig.width = 6,  fig.cap = "Comparing the output of a quasi-Poisson (green) and a negative binomial (red) model fit to the complete observed incidence rates by district of Grande Comore Island"}
# Graph of Observed and Modelled incidence data
# png(filename="Modelled vs Observed Rates (Year).jpeg", width=1200, height=1200)

ggplot(DatOut1, aes(x = Date, y = `Incidence Rates / 100,000`, group = `Rate Type`)) + 
  geom_line(aes(color = `Rate Type`), linewidth = 1) + 
  # geom_point(aes(color = Rate_Type)) +
  facet_grid(District ~ ., margins = FALSE, scales = "free", space = 'free_x') +
  # theme_classic() +
  theme(strip.text.y = element_text(angle = 0)) +
  geom_vline(xintercept = as.numeric(DatOut1$Date[65]), linetype=4, colour="black") +
  scale_x_date(date_breaks = "6 month", date_labels = "%b %Y") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1), text = element_text(size = 10)) +
  theme(legend.position="bottom")

# dev.off()
```

Overall, the quasi-Poisson model produced a better fit to the observed data, in particular during the pre-treatment period. Based on these results, we settled on a quasi-Poisson model to further analyze and characterize the incidence data for Grande Comore Island to assess the effectiveness of each form of MDA.

## Analysis of the incidence data and main results

### Establishing pre-treatment period as viable untreated (negative) control

```{r Mod3-Annual-Incidence-Variability-Pre-Treatment, echo = FALSE, include = FALSE}
# This analysis meant to get a hint of annual variability pre-treatment

# Extracts periods 2012-01-01 - 2012-09-01 and 2013-01-01 - 2013-09-01, generates binary variables for districts (2013 = 1), and sets reference to Hambou
PreDat0 <- dat0[dat0$Date >= "2012-01-01" & dat0$Date <= "2012-09-01" | dat0$Date >= "2013-01-01" & dat0$Date <= "2013-09-01",] %>%
  mutate("Centre" = ifelse(.$Year == 2013 & .$District == "Centre", 1, 0), 
         "Hamahamet" = ifelse(.$Year == 2013 & .$District == "Hamahamet", 1, 0), 
         "Hambou" = ifelse(.$Year == 2013 & .$District == "Hambou", 1, 0), 
         "Mbadjini-Est" = ifelse(.$Year == 2013 & .$District == "Mbadjini-Est", 1, 0), 
         "Mbadjini-Ouest" = ifelse(.$Year == 2013 & .$District == "Mbadjini-Ouest", 1, 0), 
         "Mitsamiouli" = ifelse(.$Year == 2013 & .$District == "Mitsamiouli", 1, 0), 
         "Oichili" = ifelse(.$Year == 2013 & .$District == "Oichili", 1, 0)) %>%
  within(., District <- relevel(District, ref = "Hamahamet"))

# Executes the quasi-Poisson model for the pre-treatment years
QPmod3 <- glm(formula = Cases ~ District + Month_1 + Centre + Hamahamet + Hambou + `Mbadjini-Est` + `Mbadjini-Ouest` + Mitsamiouli + Oichili + offset(log(Population)), family = quasipoisson(), data = PreDat0)
summary(QPmod3)
QPtab3 <- glmTable(QPmod3)
# The PseudoR^2 tells us how much of the data variability can be explained by our model
PseudoR2_QP3 <- glance(QPmod3) %>%
  summarise(PreudoR2 = 1 - deviance / null.deviance) %>%
  cbind(., ID = "Pre-Treatment") %>%
  set_rownames(.$ID) %>%
  select(., -ID)
```

In the absence of an actual untreated control group, we made use of the fact that the data set for Grande Comore Island contained almost two complete years (Jan. 2012 - Sep. 2013) of monthly pre-treatment incidence counts. Thus, we decided to compare period Jan. 2012 - Sep. 2012 to Jan. 2013 - Sep. 2013 to get a sense of annual incidence variability pre-MDA as a proxy for a untreated control against which treatment effects could be compared. The advantage of this was that untreated controls could be match to districts and treatment. In both years, the period Jan. - Sep. offered enough information about peak malaria incidence (Jan.-Mar.) and gradual decline of incidence that an informative comparison, was possible. We conducted the pre-treatment analysis initially by district for which we generated a set of binomial variables named after each district that distinguished between incidence data from 2012 (0) and 2013 (1). The Poisson regression model looked as follows:

$$
\begin{gathered}
glm(formula = Cases \sim District + Month + \\
Centre + Hamahamet + Hambou + Mbadjini-Est + Mbadjini-Ouest + Mitsamiouli + Oichili + \\
offset(log(Population)), family = quasipoisson(), data = data)
\end{gathered}
$$

```{r QPmod3-Output, echo = FALSE, include = TRUE}
summary(QPmod3)
```

```{r QPtab3-Renaming, echo = FALSE, include = FALSE}
QPtab3_1 <- QPtab3$table[c("Centre", "Hamahamet", "Hambou", "`Mbadjini-Est`", "`Mbadjini-Ouest`", "Mitsamiouli", "Oichili"), ] %>%
  set_rownames(c("Centre", "Hamahamet", "Hambou", "Mbadjini-Est", "Mbadjini-Ouest", "Mitsamiouli", "Oichili"))
```

The model had a pseudoR^2^ of `r round(PseudoR2_QP3[1,1], 3)` and the overdispersion parameter was (`r round(QPtab3$dispersion, 3)`). The results showed that the central island districts of Centre, Hamahamet, Hambou, and Oichili produced `r round(QPtab3_1["Centre", "Estimate"] * 100, 2)`%, `r round(QPtab3_1["Hamahamet", "Estimate"] * 100, 2)`%, `r round(QPtab3_1["Hambou", "Estimate"] * 100, 2)`%, and `r round(QPtab3_1["Oichili", "Estimate"] * 100, 2)`% of the 2012 incidence rates in 2013, respectively, and thus, had stable monthly incidence for both years, showing no statistically significant differences. Conversely, in the most northerly and southerly districts, Mitsamiouli, Mbadjini-Est, and Mbadjini-Ouest, there were statistically significant differences in incidence rates between 2012 and 2013 (`r QPtab3_1["Mitsamiouli", "p.value"]`, `r QPtab3_1["Mbadjini-Est", "p.value"]`, `r QPtab3_1["Mbadjini-Ouest", "p.value"]`, respectively). Specifically, while Mitsamiouli and Mbadjini-Est showed significant drops in incidence rates in 2013 compared to 2012 (`r round(QPtab3_1["Mitsamiouli", "Estimate"] * 100, 2)`%, `r round(QPtab3_1["Mbadjini-Est", "Estimate"] * 100, 2)`%, respectively), Mbadjini-Ouest showed a significant increase in malaria incidence rates (`r round(QPtab3_1["Mbadjini-Ouest", "Estimate"] * 100, 2)`%). It is important to note that these three districts also constituted the AP+PMQ~LD~ group, meaning that higher annual variability in incidence rates was to be expected for the AP+PMQ~LD~ treatment group. The model output was summarized below as the modeled proportions of the respective baseline rates (pre-treatment) for each district along with the respective 95% confidence intervals and the two-sided p-values, testing whether the effects were different from 1 (where 1 indicated 0 deviance from the respective incidence rate in 2012):

```{r QPtab3-Output, echo = FALSE, include = TRUE}
QPtab3_1
```

```{r Mod6-Quasi-Poisson-Pre-Treatment-with-Centre, echo = FALSE, include = FALSE}
# Rearranging and summarizing data: 0 = 2012, 1 = 2013
PreDat3 <- dat0 %>%
  .[.$Date >= "2012-01-01" & .$Date <= "2012-09-01" | .$Date >= "2013-01-01" & .$Date <= "2013-09-01",] %>%
  as.data.frame(.) %>%
  mutate("AP" = ifelse(.$Year == 2013 & .$Treatment == "AP", 1, 0),
         "AP.PMQ" = ifelse(.$Year == 2013 & .$Treatment == "AP+PMQLD", 1, 0))

# Quasi-Poisson models Grande Comore Island
QPmod6 <- glm(formula = Cases ~ District + Month_1 + AP + AP.PMQ + offset(log(Population)), family = quasipoisson(), data = PreDat3)
summary(QPmod6)
QPtab6 <- glmTable(QPmod6)
# The PseudoR^2 tells us how much of the data variability can be explained by our model
PseudoR2_QP6 <- glance(QPmod6) %>%
  summarise(PreudoR2 = 1 - deviance / null.deviance) %>%
  cbind(., ID = "Pre-Treatment") %>%
  set_rownames(.$ID) %>%
  select(., -ID)
```

We then substituted the generated binomial district-wise variables with two binomial variables according to treatment group where 2012 was the reference category (0). The model had a pseudoR^2^ of `r round(PseudoR2_QP6[1,1], 3)`which was substantial, but lower than the pseudoR^2 for the previous model that considered districts rather than treatment groups (`r round(PseudoR2_QP3[1,1], 3)`), while the overdispersion parameter was (`r round(QPtab6$dispersion, 3)`). In the model output we saw that AP+PMQ~LD~ treatment group showed a statistically significant drop of incidence from 2012 to 2013 (`r round(QPtab6$table["AP.PMQ", "Estimate"] * 100, 2)`%, `r QPtab6$table["AP.PMQ", "p.value"]`), while the incidence rate for the AP treatment group was relatively steady (`r round(QPtab6$table["AP", "Estimate"] * 100, 2)`%, `r QPtab6$table["AP", "p.value"]`).

```{r Mod9-Quasi-Poisson-Treatment-without-Centre, echo = FALSE, include = FALSE}
PreDat6 <- dat0[which(dat0$District != "Centre"), ] %>% 
  .[.$Date >= "2012-01-01" & .$Date <= "2012-09-01" | .$Date >= "2013-01-01" & .$Date <= "2013-09-01",] %>%
  as.data.frame(.) %>%
  mutate("AP" = ifelse(.$Year == 2013 & .$Treatment == "AP", 1, 0),
         "AP.PMQ" = ifelse(.$Year == 2013 & .$Treatment == "AP+PMQLD", 1, 0))

# Quasi-Poisson models Grande Comore Island
QPmod9 <- glm(formula = Cases ~ District + Month_1 + AP + AP.PMQ + offset(log(Population)), family = quasipoisson(), data = PreDat6)
summary(QPmod9)
QPtab9 <- glmTable(QPmod9)
# The PseudoR^2 tells us how much of the data variability can be explained by our model
PseudoR2_QP9 <- glance(QPmod9) %>%
  summarise(PreudoR2 = 1 - deviance / null.deviance) %>%
  cbind(., ID = "Pre-Treatment") %>%
  set_rownames(.$ID) %>%
  select(., -ID)
```

```{r Manually-contrasting-AP-without-and-with-Centre-1, echo = FALSE, include = FALSE}
# Manually contrasting AP without Centre vs AP with Centre (based on Michael Fay's Contrast())
Cb <- QPmod9$coefficients["AP"] + -1 * QPmod6$coefficients["AP"] # Subtracts model coefficients for AP

C6 <- matrix(c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0), 1) # Only get variance of AP
C9 <- matrix(c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0), 1) # Only get variance of AP
varCb <- C9 %*% vcov(QPmod9) %*% t(C9) + C6 %*% vcov(QPmod6) %*% t(C6) * -1 # Use inverse value for second term; when adding/subtracting means, their variance is additive

# Collate output data from comparison
C9_6 <- data.frame(estimate = round(exp(Cb), 5),
                    lower = round(exp(Cb - qnorm(.975) * sqrt(varCb)), 5),
                    upper = round(exp(Cb + qnorm(.975) * sqrt(varCb)), 5),
                    p.value = write.p(2 * (1 - pt(abs(Cb/sqrt(varCb)), df = Inf)), 4),
                    f125 = varCb / ((log(1.25) - Cb) / qnorm(.975))^2,
                    f80 = varCb / ((-log(.8) + Cb) / qnorm(.975))^2, 
                    Cb = Cb, 
                    varCb = varCb)
```

Excluding Centre from the AP treatment group due to its distinct demographics did not significantly change model outcome when compared to the outcome with Centre included (Estimate: `r round(C9_6[, "estimate"], 3)`, 95% CI: `r round(C9_6[, "lower"], 3)`, `r round(C9_6[, "upper"], 3)`, `r C9_6[, "p.value"]`). The incidence rate estimate for 2013 was marginally different for the AP treatment group (`r round(QPtab9$table["AP", "Estimate"] * 100, 2)`%, `r QPtab9$table["AP", "p.value"]`). The pseudoR^2^ (`r round(PseudoR2_QP9[1,1], 3)`) was lower, though, when excluding Centre, while the overdispersion parameter was (`r round(QPtab9$dispersion, 3)`). In general, Centre's demographic did not affect model outcome in terms of pre-treatment incidence rates, suggesting that inclusion of Centre was appropriate here.

## Determining blanket treatment effect on malaria incidence

```{r Crude-incidence-calculation, echo = FALSE, include = FALSE}
# Adjust data frame to fit function
pred <- DatOut0 %>% 
  mutate(Date = as.Date(paste("1", .$Date), format = "%d %b %Y")) %>%
  mutate("Pre_Post" = ifelse((.$Date >= "2012-01-01" & .$Date <= "2013-09-01"), "Pre", ifelse((.$Date >= "2014-01-01" & .$Date <= "2015-09-01"), "Post", "Excluded"))) %>%
  mutate("Treatment" = ifelse((.$District == "Mitsamiouli" | .$District == "Mbadjini-Est" |.$District == "Mbadjini-Ouest"), "AP.PMQ", "AP")) %>%
  .[which(.$Pre_Post == "Pre" | .$Pre_Post == "Post"),] %>%
  arrange(District)

# This gets used in the crudeIncidence()
Pops<-data.frame(District = (pred$District %>% levels(.)), Population = (pred$Population %>% unique(.)))

# Calculate crude incidence rates
capPRE <- round(crudeIncidence(pred, (pred %>% .[.$Treatment == "AP", ] %>% .$District %>% droplevels(.) %>% levels(.)), "Pre"), 2)
capPOST <- round(crudeIncidence(pred, (pred %>% .[.$Treatment == "AP", ] %>% .$District %>% droplevels(.) %>% levels(.)), "Post"), 2)

cappmqPRE <- round(crudeIncidence(pred, (pred %>% .[.$Treatment == "AP.PMQ", ] %>% .$District %>% droplevels(.) %>% levels(.)), "Pre"), 2)
cappmqPOST <- round(crudeIncidence(pred, (pred %>% .[.$Treatment == "AP.PMQ", ] %>% .$District %>% droplevels(.) %>% levels(.)), "Post"), 2)
```

For the analysis of treatment effectiveness, we defined a baseline period (pre-treatment; Jan. 2012 - Sep. 2013 [21 months]) and a post-treatment period (Jan. 2014 - Sep. 2015 [21 months]) to calculate crude monthly incidence rates per 100,000 people for each treatment group:

* For the four districts in the AP treatment group the crude rates averaged `r capPRE` for the pre-treatment period and `r capPOST` for the post-treatment period.

* For the three districts in the AP+PMQ~LD~ treatment group the crude rates averaged `r cappmqPRE` for the pre-treatment period and `r cappmqPOST` for the post-treatment period.

```{r Mod5-Annual-Incidence-Pre-vs-Post, echo = FALSE, include = FALSE}
# This analysis is meant to look at the difference between before and after treatment

# Extracts periods 2012-01-01 - 2012-09-01 and 2013-01-01 - 2013-09-01, generates binary variables for districts (2013 = 1), and sets reference to Hambou
PreDat2 <- dat0[dat0$Date >= "2012-01-01" & dat0$Date <= "2013-09-01" | dat0$Date >= "2014-01-01" & dat0$Date <= "2015-09-01", ] %>%
  mutate("Centre" = ifelse(.$Year == 2014 & .$District == "Centre" | .$Year == 2015 & .$District == "Centre", 1, 0),
         "Hamahamet" = ifelse(.$Year == 2014 & .$District == "Hamahamet" | .$Year == 2015 & .$District == "Hamahamet", 1, 0),
         "Hambou" = ifelse(.$Year == 2014 & .$District == "Hambou" | .$Year == 2015 & .$District == "Hambou", 1, 0),
         "Mbadjini-Est" = ifelse(.$Year == 2014 & .$District == "Mbadjini-Est" | .$Year == 2015 & .$District == "Mbadjini-Est", 1, 0),
         "Mbadjini-Ouest" = ifelse(.$Year == 2014 & .$District == "Mbadjini-Ouest" | .$Year == 2015 & .$District == "Mbadjini-Ouest", 1, 0),
         "Mitsamiouli" = ifelse(.$Year == 2014 & .$District == "Mitsamiouli" | .$Year == 2015 & .$District == "Mitsamiouli", 1, 0),
         "Oichili" = ifelse(.$Year == 2014 & .$District == "Oichili" | .$Year == 2015 & .$District == "Oichili", 1, 0)) %>%
  within(., District <- relevel(District, ref = "Hamahamet"))

# Executes the quasi-Poisson model for the pre-treatment years
QPmod5 <- glm(formula = Cases ~ District + Month_1 + Centre + Hamahamet + Hambou + `Mbadjini-Est` + `Mbadjini-Ouest` + Mitsamiouli + Oichili + offset(log(Population)), family = quasipoisson(), data = PreDat2)
summary(QPmod5)
QPtab5 <- glmTable(QPmod5)
# The PseudoR^2 tells us how much of the data variability can be explained by our model
PseudoR2_QP5 <- glance(QPmod5) %>%
  summarise(PreudoR2 = 1 - deviance / null.deviance) %>%
  cbind(., ID = "Pre- vs Post-Treatment") %>%
  set_rownames(.$ID) %>%
  select(., -ID)
```

We continued using the quasi-Poisson model to estimate the change in malaria incidence rates from pre- to post-treatment after controlling for districts and month of infection, while retaining the offsets by the respective total district populations. As above, we started this section of the analysis by looking at the treatment effects by district to get an appreciation of effect variability between districts, particularly, within each treatment group. The model equation is the same as above. The model had a pseudoR^2^ of `r round(PseudoR2_QP5[1,1], 3)` and a dispersion parameter of `r round(QPtab5$dispersion, 3)`.

```{r QPmod5-Output, echo = FALSE, include = TRUE}
summary(QPmod5)
```

As above, the model output was presented as the modeled proportion of the respective baseline rate (pre-treatment) for each district along with the respective 95% confidence interval and the two-sided p-value:

```{r QPtab5-Output, echo = FALSE, include = TRUE}
QPtab5_1 <- QPtab5$table[c("Centre", "Hamahamet", "Hambou", "`Mbadjini-Est`", "`Mbadjini-Ouest`", "Mitsamiouli", "Oichili"), ]%>%
  set_rownames(c("Centre", "Hamahamet", "Hambou", "Mbadjini-Est", "Mbadjini-Ouest", "Mitsamiouli", "Oichili")) %>%
  arrange(Estimate)

QPtab5_1
```

Estimates of average incidence rates post-treatment thus ranged from `r round(min(QPtab5_1$Estimate) * 100, 2)`% (95% CI: `r round(QPtab5_1[QPtab5_1$Estimate == min(QPtab5_1$Estimate), ]$lower95pctCL * 100, 2)` - `r round(QPtab5_1[QPtab5_1$Estimate == min(QPtab5_1$Estimate), ]$upper95pctCL * 100, 2)`; `r rownames(QPtab5_1[QPtab5_1$Estimate == min(QPtab5_1$Estimate), ])`) to `r round(max(QPtab5_1$Estimate) * 100, 2)`% (95% CI: `r round(QPtab5_1[QPtab5_1$Estimate == max(QPtab5_1$Estimate), ]$lower95pctCL * 100, 2)` - `r round(QPtab5_1[QPtab5_1$Estimate == max(QPtab5_1$Estimate), ]$upper95pctCL * 100, 2)`; `r rownames(QPtab5_1[QPtab5_1$Estimate == max(QPtab5_1$Estimate), ])`) of the pre-treatment incidence rates. Malaria incidence rate decreases were statistically significant for all districts (refer to the table above) regardless of the treatment applied in either district. It is worth to note that the districts of `r QPtab5_1 %>% arrange(Estimate) %>% .[c(1:3),] %>% rownames(.) %>% paste0(., collapse = ", ")`, which form the AP+PMQ~LD~ treatment group showed reductions to the lowest rates, namely `r  QPtab5_1 %>% arrange(Estimate) %>% .[c(1:3), "Estimate"] %>% multiply_by(100) %>% round(., 2) %>% paste0(., collapse = "%, ")`%, respectively.

```{r Model-containg-pseudo-negative-with-Centre, echo = FALSE, include = FALSE}
PreDat10 <- dat0 %>% 
  .[.$Date >= "2012-01-01" & .$Date <= "2012-09-01" | .$Date >= "2013-01-01" & .$Date <= "2013-09-01" | .$Date >= "2014-01-01" & .$Date <= "2014-09-01",] %>%
  as.data.frame(.) %>%
    mutate("AP" = ifelse(.$Year == 2014 & .$Treatment == "AP", 1, 0),
         "AP.PMQ" = ifelse(.$Year == 2014 & .$Treatment == "AP+PMQLD", 1, 0),
         "PRE_AP.PMQ" = ifelse(.$Year == 2013 & .$Treatment == "AP+PMQLD", 1, 0),
         "PRE_AP" = ifelse(.$Year == 2013 & .$Treatment == "AP", 1, 0))

# Quasi-Poisson models Grande Comore Island
QPmod12 <- glm(formula = Cases ~ District + Month_1 + AP + AP.PMQ + PRE_AP + PRE_AP.PMQ + offset(log(Population)), family = quasipoisson(), data = PreDat10)
summary(QPmod12)
QPtab12 <- glmTable(QPmod12)
# The PseudoR^2 tells us how much of the data variability can be explained by our model
PseudoR2_QP12 <- glance(QPmod12) %>%
  summarise(PreudoR2 = 1 - deviance / null.deviance) %>%
  cbind(., ID = "Pre- vs Post-Treatment") %>%
  set_rownames(.$ID) %>%
  select(., -ID)
```

To further assess whether AP+PMQ~LD~-MDA performed statistically significantly better than AP-MDA in reducing malaria incidence rates, we used the quasi-Poisson model controlling for district, month, and treatment type while offsetting by the population of each district. As we needed an untreated control to establish treatment effectiveness (see below), we made use of the extended pre-treatment data available for Grande Comore Island as established in section 2.2.1. To use the 21 months pre-treatment data as an untreated control, we needed to shorten the the baseline period by 12 months from Jan. 2012 - Sep. 2013 to Jan. 2012 - Sep. 2012 compared to the previous model above that analyzed the incidence rate variability pre- to post-MDA between districts. This allowed us then to compare 9 month of 2012 to 9 months in 2013 (Jan. 2013 - Sep. 2013) - both pre-treatment years - to build an untreated control. To analyze changes in incidence rates due to either MDA, the 2012 period was also compared to 9 month of post-treatment data (Jan. 2014 - Sep. 2014). This enabled us to match each treatment group with its respective untreated control by month. This mattered because of the changes of malaria incidence between wet and dry season over the course of a year (Fig. 8)

```{r QPmod12-Output, echo = FALSE, include = TRUE}
summary(QPmod12)
```

The model's pseudoR^2^ was `r round(PseudoR2_QP12[1,1], 3)`, while the dispersion parameter was `r round(QPtab12$dispersion, 3)`. Both treatments, AP and AP+PMQ~LD~, showed significant effects, dropping the malaria incidence rates to `r round(QPtab12$table["AP", "Estimate"] * 100, 2)`% and `r round(QPtab12$table["AP.PMQ", "Estimate"] * 100, 2)`% of the pre-treatment incidence rates, respectively. Although the districts that were to receive AP+PMQ~LD~ had showed a statistically significant drop in malaria incidence during the control period from 2012 to 2013 (pre-treatment: `r round(QPtab12$table["PRE_AP.PMQ", "Estimate"] * 100, 2)`%, `r QPtab12$table["AP", "p.value"]`), the effect that resulted from AP+PMQ~LD~ treatment was much larger.

```{r QPtab12-Output, echo = FALSE, include = TRUE}
QPtab12$table[c("AP", "AP.PMQ", "PRE_AP", "PRE_AP.PMQ"), ]
```

```{r Wald-test-for-contrast-between-treatment-outcomes-without-Centre-accortind-to-Michael-Fay-1, echo = FALSE, include = FALSE}
C12_1 <- Contrasts(matrix(c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,-1,0,0), 1), QPmod12) # AP vs AP+PMQ; Uses Treatment as main effect (including Centre)
C12_2 <- Contrasts(matrix(c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,-1,0), 1), QPmod12) # AP; Uses Treatment as main effect (including Centre)
C12_3 <- Contrasts(matrix(c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,-1), 1), QPmod12) # AP+PMQ; Uses Treatment as main effect (including Centre)
C12_4 <- Contrasts(matrix(c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,-1), 1), QPmod12) # Comparing untreated controls; Uses Treatment as main effect (including Centre)

# Treatments were highly effective as can be seen from their significant difference from zero (0)
1 - (QPtab12$table["AP", "Estimate"] / QPtab12$table["PRE_AP", "Estimate"])
1 - C12_2["estimate"]
1 - (QPtab12$table["AP.PMQ", "Estimate"] / QPtab12$table["PRE_AP.PMQ", "Estimate"])
1 - C12_3["estimate"]

# AP+PMQ was about twice as effective as AP alone, but the result is not statistically significant as one (1) is included in the 95%CI
round(QPtab12$table["AP","Estimate"],4)/round(QPtab12$table["AP.PMQ","Estimate"],4)
round(C12_1["estimate"],4)

# untreated control comparison shows that they were already statistically significantly different to start with; AP+PMQ had lower incidence rates in 2013 and the AP area
round(QPtab12$table["PRE_AP","Estimate"],4)/round(QPtab12$table["PRE_AP.PMQ","Estimate"],4)
round(C12_4["estimate"],5)
```

To assess treatment effectiveness, we followed the example of vaccine effectiveness calculation where effectiveness is defined as 1 minus the ratio of the incidence rate after treatment divided by the incidence rate in untreated controls [@Jefferson2005]. Using the pre-treatment data as matched untreated controls to their respective treatment groups, treatment effectiveness of AP was 1 - `r round(QPtab12$table["AP", "Estimate"], 4)`/`r round(QPtab12$table["PRE_AP", "Estimate"], 4)` = `r round(1 - C12_2[, "estimate"], 4)` (95% CI: `r round(1 - C12_2[, "upper"], 4)`, `r round(1 -  C12_2[, "lower"], 4)`), which was significantly different from 0 (`r C12_2[, "p.value"]`), where 0 meant no effect. Treatment effectiveness of AP+PMQ~LD~ was 1 - `r round(QPtab12$table["AP.PMQ", "Estimate"], 4)`/`r round(QPtab12$table["PRE_AP.PMQ", "Estimate"], 4)` = `r round(1 - C12_3[, "estimate"], 4)` (95% CI: `r round(1 - C12_3[, "upper"], 4)`, `r round(1 -  C12_3[, "lower"], 4)`), which was also statistically significant (`r C12_3[, "p.value"]`). Note that, although we assumed a stable population along the months/years of data collection, treatment effectiveness would have remained the same if all populations changed by the same factor over time, as the treatment effectiveness was based on a ratio of rate ratios.

To determine, if there were significant differences between the treatment effectiveness of AP and AP+PMQ~LD~, we compared the post-treatment rates as a percentage of the baseline. The ratio of those rate ratios was `r round(QPtab12$table["AP", "Estimate"], 4)`/`r round(QPtab12$table["AP.PMQ", "Estimate"], 4)` = `r round(C12_1[, "estimate"], 4)` (95% CI: `r round(C12_1[, "lower"], 4)`, `r round(C12_1[, "upper"], 4)`). Although presenting an ~2-fold difference in the ratio of rate ratios, this outcome was borderline not statistically significant from 1 (`r C12_1[, "p.value"]`) due to the wide 95% confidence intervals that included 1. To have enough precision to be 95% confident that the ratio of rate ratios was within the range [0.80, 1.25], we would only need to repeat the experiment about `r round(C12_1[, "f125"], 0)` times, assuming we achieved the same estimate of the ratio and its variance. We also compared the two untreated controls which were the changes in rates from 2012 to 2013 in the districts that were to receive AP or AP+PMQ~LD~ (`r round(QPtab12$table["PRE_AP", "Estimate"], 4)`/`r round(QPtab12$table["PRE_AP.PMQ", "Estimate"], 4)` = `r round(C12_4[, "estimate"], 4)` (95% CI: `r round(C12_4[, "lower"], 4)`, `r round(C12_4[, "upper"], 4)`)) and we confirmed that the pre-treatment differences observed in the AP+PMQ~LD~ group made this control statistically significantly different from the AP control (`r C12_4[, "p.value"]`; see section 2.2.1 above). 

```{r Model-containg-pseudo-negative-without-Centre, echo = FALSE, include = FALSE}
PreDat11 <- dat0[which(dat0$District != "Centre"), ] %>% 
  .[.$Date >= "2012-01-01" & .$Date <= "2012-09-01" | .$Date >= "2013-01-01" & .$Date <= "2013-09-01" | .$Date >= "2014-01-01" & .$Date <= "2014-09-01",] %>%
  as.data.frame(.) %>%
    mutate("AP" = ifelse(.$Year == 2014 & .$Treatment == "AP", 1, 0),
         "AP.PMQ" = ifelse(.$Year == 2014 & .$Treatment == "AP+PMQLD", 1, 0),
         "PRE_AP" = ifelse(.$Year == 2013 & .$Treatment == "AP", 1, 0),
         "PRE_AP.PMQ" = ifelse(.$Year == 2013 & .$Treatment == "AP+PMQLD", 1, 0))

# Quasi-Poisson models Grande Comore Island
QPmod13 <- glm(formula = Cases ~ District + Month_1 + AP + AP.PMQ + PRE_AP + PRE_AP.PMQ + offset(log(Population)), family = quasipoisson(), data = PreDat11)
summary(QPmod13)
QPtab13 <- glmTable(QPmod13)
# The PseudoR^2 tells us how much of the data variability can be explained by our model
PseudoR2_QP13 <- glance(QPmod13) %>%
  summarise(PreudoR2 = 1 - deviance / null.deviance) %>%
  cbind(., ID = "Pre- vs Post-Treatment") %>%
  set_rownames(.$ID) %>%
  select(., -ID)
```

As before, we repeated the analysis, excluding Centre due to its distinct demographics compared to the other districts. Here, the model's pseudoR^2^ was `r round(PseudoR2_QP13[1,1], 3)`, while the dispersion parameter was `r round(QPtab13$dispersion, 3)`. AP showed a slightly reduced, but statistically significant effect, dropping the malaria incidence rates to `r round(QPtab13$table["AP", "Estimate"] * 100, 2)`% of the pre-treatment incidence rates. The AP+PMQ~LD~ treatment group and its controls remained unchanged. 

```{r QPmod13-Output, echo = FALSE, include = TRUE}
QPtab13$table[c("AP", "AP.PMQ", "PRE_AP", "PRE_AP.PMQ"), ]
```


```{r Wald-test-for-contrast-between-treatment-outcomes-without-Centre-accortind-to-Michael-Fay-2, echo = FALSE, include = FALSE}
C13_1 <- Contrasts(matrix(c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,-1,0,0), 1), QPmod13) # Uses Treatment as main effect (excluding Centre)
C13_2 <- Contrasts(matrix(c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,-1,0), 1), QPmod13) # Uses Treatment as main effect (excluding Centre)
C13_3 <- Contrasts(matrix(c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,-1), 1), QPmod13) # Uses Treatment as main effect (excluding Centre)
C13_4 <- Contrasts(matrix(c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,-1), 1), QPmod13) # Uses Treatment as main effect (excluding Centre)

# Treatments were highly effective as can be seen from their significant difference from zero (0)
1 - (QPtab13$table["AP", "Estimate"] / QPtab13$table["PRE_AP", "Estimate"])
1 - C13_2["estimate"]
1 - (QPtab13$table["AP.PMQ", "Estimate"] / QPtab13$table["PRE_AP.PMQ", "Estimate"])
1 - C13_3["estimate"]

# AP+PMQ was about twice as effective as AP alone, but the result is not statistically significant as one (1) is included in the 95%CI
round(QPtab13$table["AP","Estimate"],4)/round(QPtab13$table["AP.PMQ","Estimate"],4)
round(C13_1["estimate"],5)

# untreated control comparison shows that they were already statistically significantly different to start with; AP+PMQ had lower incidence rates in 2013 and the AP area
round(QPtab13$table["PRE_AP","Estimate"],4)/round(QPtab13$table["PRE_AP.PMQ","Estimate"],4)
round(C13_4["estimate"],5)
```

Treatment effectiveness of AP was 1 - `r round(QPtab13$table["AP", "Estimate"], 4)`/`r round(QPtab13$table["PRE_AP", "Estimate"], 4)` = `r round(1 - C13_2[, "estimate"], 4)` (95% CI: `r round(1 - C13_2[, "upper"], 4)`, `r round(1 -  C13_2[, "lower"], 4)`) without Centre, and remained significantly different from 0 (`r C13_2[, "p.value"]`). Comparing post-treatment rates as a percentage of the baseline, calculations showed that the ratio of the rate ratios was `r round(QPtab13$table["AP", "Estimate"], 4)`/`r round(QPtab13$table["AP.PMQ", "Estimate"], 4)` = `r round(C13_1[, "estimate"], 4)` (95% CI: `r round(C13_1[, "lower"], 4)`, `r round(C13_1[, "upper"], 4)`), meaning that the reduction in incidence rate was now statistically significantly higher for AP+PMQ~LD~ compared to AP alone (`r C13_1[, "p.value"]`) with sufficient precision to be 95% confident that the ratio of rate ratios was not within the range [0.80, 1.25] (`r round(C13_1[, "f125"], 0)` time). We also compared again the two untreated controls for the districts that were to receive AP or AP+PMQ~LD~ (`r round(QPtab13$table["PRE_AP", "Estimate"], 4)`/`r round(QPtab13$table["PRE_AP.PMQ", "Estimate"], 4)` = `r round(C13_4[, "estimate"], 4)` (95% CI: `r round(C13_4[, "lower"], 4)`, `r round(C13_4[, "upper"], 4)`)), and confirmed that the exclusion of Centre did not alter the statistically significant difference between both these controls (`r C13_4[, "p.value"]`).

```{r Manually-contrasting-AP-without-and-with-Centre-2, echo = FALSE, include = FALSE}
# Manually contrasting AP without Centre vs AP with Centre (based on Michael Fay's Contrast())
Cb <- QPmod13$coefficients["AP"] + -1 * QPmod12$coefficients["AP"] # Subtracts model coefficients for AP

C12 <- matrix(c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0), 1) # Only get variance of AP
C13 <- matrix(c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0), 1) # Only get variance of AP
varCb <- C13 %*% vcov(QPmod13) %*% t(C13) + C12 %*% vcov(QPmod12) %*% t(C12) * -1 # Use inverse value for second term; when adding/subtracting means, their variance is additive

# Collate output data from comparison
C13_12 <- data.frame(estimate = round(exp(Cb), 5),
                    lower = round(exp(Cb - qnorm(.975) * sqrt(varCb)), 5),
                    upper = round(exp(Cb + qnorm(.975) * sqrt(varCb)), 5),
                    p.value = write.p(2 * (1 - pt(abs(Cb/sqrt(varCb)), df = Inf)), 5),
                    f125 = varCb / ((log(1.25) - Cb) / qnorm(.975))^2,
                    f80 = varCb / ((-log(.8) + Cb) / qnorm(.975))^2, 
                    Cb = Cb, 
                    varCb = varCb)
```

The exclusion of Centre from the AP treatment group did not significantly change model outcome (Estimate: `r round(C13_12[, "estimate"], 3)`, 95% CI: `r round(C13_12[, "lower"], 3)`, `r round(C13_12[, "upper"], 3)`, `r C13_12[, "p.value"]`). The incidence rate reduction reflected in 2014 after AP treatment was only marginally different excluding Centre compared to the rate including Centre (`r round(QPtab13$table["AP", "Estimate"] * 100, 2)`% vs `r round(QPtab12$table["AP", "Estimate"] * 100, 2)`%). In general, excluding Centre based on its distinct demographics did not affect model outcome by much, but changed a marginally non-significant difference in post-treatment rates to a statistically significant difference, when compared to the rates after MDA with AP+PMQ~LD~.

### Assessing stability of treatment effictiveness over four years post-treatment

```{r Mod4-Annual-Incidence-Variability-Post-Treatment, echo = FALSE, include = FALSE}
# This analysis is looking at how the incidence changes post treatment of the course of four years compared to the first year post treatment

# Extracts periods 2012-01-01 - 2012-09-01 and 2013-01-01 - 2013-09-01, generates binary variables for districts (2013 = 1), and sets reference to Hambou
PreDat1 <- dat0[dat0$Date >= "2014-01-01" & dat0$Date <= "2017-12-01",] %>%
  mutate("Centre" = ifelse(.$Year == 2015 & .$District == "Centre", 1, 
                           ifelse(.$Year == 2016 & .$District == "Centre", 2, 
                                  ifelse(.$Year == 2017 & .$District == "Centre", 3, 0))), 
         "Hamahamet" = ifelse(.$Year == 2015 & .$District == "Hamahamet", 1, 
                              ifelse(.$Year == 2016 & .$District == "Hamahamet", 2, 
                                     ifelse(.$Year == 2017 & .$District == "Hamahamet", 3, 0))), 
         "Hambou" = ifelse(.$Year == 2015 & .$District == "Hambou", 1, 
                           ifelse(.$Year == 2016 & .$District == "Hambou", 2, 
                                  ifelse(.$Year == 2017 & .$District == "Hambou", 3, 0))), 
         "Mbadjini-Est" = ifelse(.$Year == 2015 & .$District == "Mbadjini-Est", 1, 
                                 ifelse(.$Year == 2016 & .$District == "Mbadjini-Est", 2, 
                                        ifelse(.$Year == 2017 & .$District == "Mbadjini-Est", 3, 0))), 
         "Mbadjini-Ouest" = ifelse(.$Year == 2015 & .$District == "Mbadjini-Ouest", 1, 
                                   ifelse(.$Year == 2016 & .$District == "Mbadjini-Ouest", 2, 
                                          ifelse(.$Year == 2017 & .$District == "Mbadjini-Ouest", 3, 0))), 
         "Mitsamiouli" = ifelse(.$Year == 2015 & .$District == "Mitsamiouli", 1, 
                                ifelse(.$Year == 2016 & .$District == "Mitsamiouli", 2, 
                                       ifelse(.$Year == 2017 & .$District == "Mitsamiouli", 3, 0))), 
         "Oichili" = ifelse(.$Year == 2015 & .$District == "Oichili", 1, 
                            ifelse(.$Year == 2016 & .$District == "Oichili", 2, 
                                   ifelse(.$Year == 2017 & .$District == "Oichili", 3, 0)))) %>%
  within(., District <- relevel(District, ref = "Hamahamet"))

# Executes the quasi-Poisson model for the pre-treatment years
QPmod4 <- glm(formula = Cases ~ District + Month_1 + Centre + Hamahamet + Hambou + `Mbadjini-Est` + `Mbadjini-Ouest` + Mitsamiouli + Oichili + offset(log(Population)), family = quasipoisson(), data = PreDat1)
summary(QPmod4)
QPtab4 <- glmTable(QPmod4)
# The PseudoR^2 tells us how much of the data variability can be explained by our model
PseudoR2_QP4 <- glance(QPmod4) %>%
  summarise(PreudoR2 = 1 - deviance / null.deviance) %>%
  cbind(., ID = "Post-Treatment") %>%
  set_rownames(.$ID) %>%
  select(., -ID)
```

```{r Wald-test-for-contrast-between-treatment-outcomes-without-Centre-accortind-to-Michael-Fay-5, echo = FALSE, include = FALSE}
# Contrasting 2017 to 2014, 2015, and 2016
C2_1 <- Contrasts(matrix(c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1,0,0,1), 1), QPmod2)
C2_2 <- Contrasts(matrix(c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1,0,1), 1), QPmod2)
C2_3 <- Contrasts(matrix(c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1,1), 1), QPmod2)

C2 <- rbind(C2_1, C2_2, C2_3)
```

To assess the medical impact of MDA with AP or AP+PMQ~LD~ from a statistical perspective, we examined malaria incidence rates through the four year post-treatment period until Dec 2017. We knew from the full model fitting in section 2.2.1. that the malaria incidence rates were significantly reduced in years 2014  2017 compared to 2012  (`r  paste0(round(tail(QPtab2$table, 4)[, "Estimate"] * 100, 2), collapse = "%, ")`%, respectively), while 2013 as the final pre-MDA year still showed malaria incidence rates comparable to 2012 (`r round(QPtab2$table["Year2013", "Estimate"] * 100, 2)`%). It was noted, however, that 2017 showed a `r paste0(round(C2[, "estimate"], 2), collapse = ", ")`-fold higher incidence rates compared to each of the previous 3 years (2014 - 2016), respectively, which was statistically significant (`r paste0(C2[, "p.value"], collapse = ", ")`). 

```{r QPtab2-recap, echo = FALSE, include = TRUE}
# This is data drawn from the full model applied to predict observed incidence rates in 2.2.1.
QPtab2$table[rownames(QPtab2$table) %like% "Year",]
```

To take a closer look at these increases in malaria incidence rates in the post-MDA period, we used the first full year post-MDA (Jan. 2014 - Dec. 2014) as the baseline reference, to which the incidence rates of the years of 2015, 2016, and 2017 were compared. The model was again controlled for district and month and offset by total district population. The pseudoR^2^ was `r round(PseudoR2_QP4[1,1], 3)`, while the dispersion parameter was `r round(QPtab4$dispersion, 3)`.

```{r Re-arrange-QPtab4-Output, echo = FALSE, include = FALSE}
QPtab4_1 <- QPtab4$table[c("Centre", "Hamahamet", "Hambou", "`Mbadjini-Est`", "`Mbadjini-Ouest`", "Mitsamiouli", "Oichili"), ] %>%
  set_rownames(c("Centre", "Hamahamet", "Hambou", "Mbadjini-Est", "Mbadjini-Ouest", "Mitsamiouli", "Oichili")) %>%
  arrange(Estimate)
```

The results showed that except for `r rownames(head(QPtab4_1,1))`, all other districts saw an increase of `r round(QPtab4_1[2, "Estimate"], 2)`-fold (`r rownames(QPtab4_1[2,])`) to `r round(QPtab4_1[rownames(tail(QPtab4_1,1)), "Estimate"], 2)`-fold (`r rownames(tail(QPtab4_1,1))`) fold increase in malaria incidence rates toward 2017. While all these increases in malaria incidence rates were statistically significant but for `r rownames(QPtab4_1[2,])` (refer to the table below), these increases were small. `r rownames(head(QPtab4_1,1))` was the only district that showed a decline (`r round((1 - QPtab4_1[1, "Estimate"]) * 100, 2)`%) in incidence rate post-2014, which was at least partially due to the fact that during 2014, malaria incidence was relatively higher than in the other districts and also in Hambou itself in 2015, 2016, and 2017 as evident in figure (Figs. 8).

```{r QPtab4-Output, echo = FALSE, include = TRUE}
QPtab4_1
```

```{r Mod7-Quasi-Poisson-Post-Treatment-with-Centre, echo = FALSE, include = FALSE}
# Rearranging and summarizing data: 0 = 20124, 1 = 2015, 2 = 2016, 3 = 2017
PreDat4 <- dat0 %>% 
  .[.$Date >= "2014-01-01" & .$Date <= "2017-12-01" ,] %>%
  as.data.frame(.) %>%
  mutate("AP" = ifelse(.$Year == 2015 & .$Treatment == "AP", 1, 
                       ifelse(.$Year == 2016 & .$Treatment == "AP", 2, 
                              ifelse(.$Year == 2017 & .$Treatment == "AP", 3, 0))),
         "AP.PMQ" = ifelse(.$Year == 2015 & .$Treatment == "AP+PMQLD", 1, 
                           ifelse(.$Year == 2016 & .$Treatment == "AP+PMQLD", 2, 
                                  ifelse(.$Year == 2017 & .$Treatment == "AP+PMQLD", 3, 0))))

# Quasi-Poisson models Grande Comore Island
QPmod7 <- glm(formula = Cases ~ District + Month_1 + AP + AP.PMQ + offset(log(Population)), family = quasipoisson(), data = PreDat4)
summary(QPmod7)
QPtab7 <- glmTable(QPmod7)
# The PseudoR^2 tells us how much of the data variability can be explained by our model
PseudoR2_QP7 <- glance(QPmod7) %>%
  summarise(PreudoR2 = 1 - deviance / null.deviance) %>%
  cbind(., ID = "Post-Treatment") %>%
  set_rownames(.$ID) %>%
  select(., -ID)
```

```{r Wald-test-for-contrast-between-treatment-outcomes-without-Centre-accortind-to-Michael-Fay-3, echo = FALSE, include = FALSE}
# Contrsting AP to AP+PMQ
C7_1 <- Contrasts(matrix(c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1,1), 1), QPmod7)
```

Repeating the analysis by treatment group (prsudoR^2: `r round(PseudoR2_QP7[1,1], 3)`, dispersion parameter: `r round(QPtab7$dispersion, 3)`) showed that both treatment groups showed statistically significant increases in malaria incidence rates by 2017 (AP: `r round(QPtab7$table["AP", "Estimate"], 2)`-fold increase [`r QPtab7$table["AP", "p.value"]`]; AP+PMQ~LD~: `r round(QPtab7$table["AP.PMQ", "Estimate"], 2)`-fold increase [`r QPtab7$table["AP.PMQ", "p.value"]`]). Looking at the table above, the lower increase in incidence rate in the AP treatment group was expected as the 4 districts constituting this group (`r paste0(rownames(QPtab4_1[c(1:4),]) %>% sort(.), collapse = ", ")`) had all shown lower increases in incidence rates than the three districts that constituted AP+PMQ~LD~ (`r paste0(rownames(QPtab4_1[c(5:7),]) %>% sort(.), collapse = ", ")`). Interestingly, while the MDA using AP+PMQ~LD~ had shown a slightly greater treatment effectiveness over the MDA using AP alone (`r round(1 - C12_3[, "estimate"], 4)` vs `r round(1 - C12_2[, "estimate"], 4)`), it was also associated with a greater increase in incidence rate in the years following MDA compared to the AP treatment group (`r round(QPtab7$table["AP.PMQ", "Estimate"], 2)`-fold vs `r round(QPtab7$table["AP", "Estimate"], 2)`-fold; both increases in incidence are statistically significant (`r QPtab7$table["AP.PMQ", "p.value"]` and `r QPtab7$table["AP", "p.value"]`)).

```{r QPtab7-Output, echo = FALSE, include = TRUE}
QPtab7$table[c("AP", "AP.PMQ"), ]
```

```{r Mod10-Quasi-Poisson-Post-Treatment-without-Centre, echo = FALSE, include = FALSE}
PreDat7 <- dat0[which(dat0$District != "Centre"), ] %>% 
  .[.$Date >= "2014-01-01" & .$Date <= "2017-12-01" ,] %>%
  as.data.frame(.) %>%
  mutate("AP" = ifelse(.$Year == 2015 & .$Treatment == "AP", 1, 
                       ifelse(.$Year == 2016 & .$Treatment == "AP", 2, 
                              ifelse(.$Year == 2017 & .$Treatment == "AP", 3, 0))),
         "AP.PMQ" = ifelse(.$Year == 2015 & .$Treatment == "AP+PMQLD", 1, 
                           ifelse(.$Year == 2016 & .$Treatment == "AP+PMQLD", 2, 
                                  ifelse(.$Year == 2017 & .$Treatment == "AP+PMQLD", 3, 0))))

# Quasi-Poisson models Grande Comore Island
QPmod10 <- glm(formula = Cases ~ District + Month_1 + AP + AP.PMQ + offset(log(Population)), family = quasipoisson(), data = PreDat7)
summary(QPmod10)
QPtab10 <- glmTable(QPmod10)
# The PseudoR^2 tells us how much of the data variability can be explained by our model
PseudoR2_QP10 <- glance(QPmod10) %>%
  summarise(PreudoR2 = 1 - deviance / null.deviance) %>%
  cbind(., ID = "Post-Treatment") %>%
  set_rownames(.$ID) %>%
  select(., -ID)
```

```{r Manually-contrasting-AP-without-and-with-Centre-4, echo = FALSE, include = FALSE}
# Manually contrasting AP without Centre vs AP with Centre (based on Michael Fay's Contrast())
Cb <- QPmod10$coefficients["AP"] + -1 * QPmod7$coefficients["AP"] # Subtracts model coefficients for AP

C7 <- matrix(c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0), 1) # Only get variance of AP
C10 <- matrix(c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0), 1) # Only get variance of AP
varCb <- C10 %*% vcov(QPmod10) %*% t(C10) + C7 %*% vcov(QPmod7) %*% t(C7) * -1 # Use inverse value for second term; when adding/subtracting means, their variance is additive

# Collate output data from comparison
C10_7 <- data.frame(estimate = round(exp(Cb), 5),
                    lower = round(exp(Cb - qnorm(.975) * sqrt(varCb)), 5),
                    upper = round(exp(Cb + qnorm(.975) * sqrt(varCb)), 5),
                    p.value = write.p(2 * (1 - pt(abs(Cb/sqrt(varCb)), df = Inf)), 5),
                    f125 = varCb / ((log(1.25) - Cb) / qnorm(.975))^2,
                    f80 = varCb / ((-log(.8) + Cb) / qnorm(.975))^2, 
                    Cb = Cb, 
                    varCb = varCb)
```

Excluding Centre here did also not result in significant changes to the outcome of the AP group (`r C10_7[1, "p.value"]`). Thus, the inclusion of Centre was appropriate.

In conclusion, AP only and AP+PMQ~LD~ accomplished similar decreases in malaria incidence rate after only two rounds of MDA on Grande Comore Island. Just as importantly, in the four years following the MDA, malaria incidence remained low, although small increases in incidence rates were observed by 2017, which could have involved various influences on annual malaria transmission. Follow up studies will be required to determine whether continued efforts can keep malaria incidence low in the long run. It must be noted that MDA was not the only intervention method in use during the study period, as distributions of long-lasting insecticidal nets and focal applications of indoor residual spraying were made available by the Comoros National Malaria Control Program before and after MDA. Nevertheless, the use of two rounds of AP only for MDA may be sufficient to dramatically suppress the malaria transmission cycle in settings like Grande Comore Island.

# Comparison of the malaria incidence data of Grande Comore Island, Union of Comore, to study outcomes from Anjouan Island, Union of Grande Comore

```{r with-Centre, echo = FALSE, include = FALSE}
# Generates combined dataframe for both islands looking a 6 months pre- and 6 months post-treatment
CompDat0 <- rbind(PreDat10 %>%
                    .[.$Date >= "2012-04-01" & .$Date <= "2012-09-01" | .$Date >= "2013-04-01" & .$Date <= "2013-09-01" | .$Date >= "2014-04-01" & .$Date <= "2014-09-01",] %>%
                    mutate("AP_AI" = ifelse(.$Year == 2011 & .$Treatment == "AP", 1, 0),
                           "AP.PMQ_AI" = ifelse(.$Year == 2011 & .$Treatment == "AP+PMQLD", 1, 0),
                           "PRE" = ifelse(.$Year == 2013, 1, 0)) %>%
                    select(Island, Month_1, Year, Date, District, Treatment, Cases, Population, AP.PMQ, AP, AP.PMQ_AI, AP_AI, PRE_AP.PMQ, PRE_AP, PRE),
                  
                  dat$`Anjouan Island` %>%
                    .[.$Date >= "2012-04-01" & .$Date <= "2012-09-01" | .$Date >= "2013-04-01" & .$Date <= "2013-09-01",] %>%
                    as.data.frame(.) %>%
                    mutate("AP" = ifelse(.$Year == 2011 & .$Treatment == "AP", 1, 0),
                           "AP.PMQ" = ifelse(.$Year == 2011 & .$Treatment == "AP+PMQLD", 1, 0),
                           "AP_AI" = ifelse(.$Year == 2013 & .$Treatment == "AP", 1, 0),
                           "AP.PMQ_AI" = ifelse(.$Year == 2013 & .$Treatment == "AP+PMQLD", 1, 0),
                           "PRE_AP" = ifelse(.$Year == 2011 & .$Treatment == "AP", 1, 0),
                           "PRE_AP.PMQ" = ifelse(.$Year == 2011 & .$Treatment == "AP+PMQLD", 1, 0),
                           "PRE" = ifelse(.$Year == 2011, 1, 0)) %>%
                    select(Island, Month_1, Year, Date, District, Treatment, Cases, Population, AP.PMQ, AP, AP.PMQ_AI, AP_AI, PRE_AP.PMQ, PRE_AP, PRE)
                  )

# Quasi-Poisson models Grande Comore Island
QPmod14 <- glm(formula = Cases ~ District + Month_1 + AP + AP.PMQ + AP_AI + AP.PMQ_AI + PRE + offset(log(Population)), family = quasipoisson(), data = CompDat0)
summary(QPmod14)
QPtab14 <- glmTable(QPmod14)
# The PseudoR^2 tells us how much of the data variability can be explained by our model
PseudoR2_QP14 <- glance(QPmod14) %>%
  summarise(PreudoR2 = 1 - deviance / null.deviance) %>%
  cbind(., ID = "Pre- vs Post-Treatment") %>%
  set_rownames(.$ID) %>%
  select(., -ID)
```

```{r Wald-test-for-contrast-between-treatment-outcomes-without-Centre-accortind-to-Michael-Fay-4, echo = FALSE, include = FALSE}
C14_1 <- Contrasts(matrix(c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,-1,0,0,0), 1), QPmod14) # AP vs AP.PMQ (Gradne Comore Island)
C14_2 <- Contrasts(matrix(c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,-1), 1), QPmod14) # AP vs PRE_AP (Gradne Comore Island)
C14_3 <- Contrasts(matrix(c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,-1), 1), QPmod14) # AP.PMQ vs PRE_AP.PMQ (Gradne Comore Island)

C14_5 <- Contrasts(matrix(c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,-1,0), 1), QPmod14) # AP_AI vs AP.PMQ_AI (Anjouan Island)
C14_6 <- Contrasts(matrix(c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,-1,0,0), 1), QPmod14) # AP vs AP_AI
C14_7 <- Contrasts(matrix(c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,-1,0), 1), QPmod14) # AP.PMQ vs AP.PMQ_AI

C14_8 <- Contrasts(matrix(c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,-1), 1), QPmod14) # AP_AI vs PRE
C14_9 <- Contrasts(matrix(c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,-1), 1), QPmod14) # AP.PMQ_AI vs PRE

# Treatments were highly effective as can be seen from their significant difference from zero (0)
1 - (QPtab14$table["AP", "Estimate"] / QPtab14$table["PRE", "Estimate"])
1 - C14_2["estimate"]
1 - (QPtab14$table["AP.PMQ", "Estimate"] / QPtab14$table["PRE", "Estimate"])
1 - C14_3["estimate"]
1 - (QPtab14$table["AP_AI", "Estimate"] / QPtab14$table["PRE", "Estimate"])
1 - C14_8["estimate"]
1 - (QPtab14$table["AP.PMQ_AI", "Estimate"] / QPtab14$table["PRE", "Estimate"])
1 - C14_9["estimate"]

# AP+PMQ was about twice as effective as AP alone, but the result is not statistically significant as one (1) is included in the 95%CI
round(QPtab14$table["AP","Estimate"],4)/round(QPtab14$table["AP.PMQ","Estimate"],4)
round(C14_1["estimate"],5)

round(QPtab14$table["AP_AI","Estimate"],4)/round(QPtab14$table["AP.PMQ_AI","Estimate"],4)
round(C14_5["estimate"],4)

round(QPtab14$table["AP","Estimate"],4)/round(QPtab14$table["AP_AI","Estimate"],4)
round(C14_6["estimate"],4)

round(QPtab14$table["AP.PMQ","Estimate"],4)/round(QPtab14$table["AP.PMQ_AI","Estimate"],4)
round(C14_7["estimate"],4)
```

Prior to the MDA on Grand Comore Island, MDA with AP only or AP+PMQ~LD~ was applied across the districts of Anjouan Island in the Union of Comoros [@Deng2018]. The major difference was that on Anjouan Island three rounds of Ap only or AP+PMQ~LD~ were administered. On Grande Comore Island, only two rounds of MDA were given as the experiences from Anjouan Island suggested that a third round of MDA contributed little additional effect. In addition, our study on Anjouan Island suggested that the addition of low dose primaquine (PMQ~LD~) provided little or no additional effect. Dropping the third round of MDA as well as PMQ~LD~ can considerably reduce the funding and resources required for implementation of MDA. In this section, we use data from the outcomes on the Anjouan and Grande Comore Islands to compare the effectiveness of two relative to three monthly rounds of AP only or AP+PMQ~LD~.

We obtained the published data from Deng et al. (2018) and recreated their analysis using 6 month periods for baseline and post-treatment (Anjouan Island: Apr. 2012 - Sep. 2012 vs Apr. 2013 - Sep. 2013; Grande Comore Island: Apr. 2012 - Sep. 2012 vs Apr. 2014 - Sep. 2014) [@Deng2018]. The pre-MDA data of the seven districts of Grande Comore Island had previously been used by Deng et al. (2018) as an untreated (negative) control for analysis of the outcomes on Anjouan Island in Apr. 2013 - Sep. 2013 after MDA in OctoberDecember 2012. In the absence of data from another untreated control island, we did the same by comparing Apr. 2012 - Sep. 2012 with Apr. 2013 - Sep. 2013 of the pre-treatment data from Grande Comore Island. Because the untreated control was based on Grande Comore Island rather than a third island, we could not match the untreated control to MDA types as that would have biased toward Grande Comore Island. Instead, we generate an unmatch general control based on all 7 districts of Grande Comore Island that could be used unbiasedly for both Anjouan and Grande Comore Island. The quasi-Poisson model had a pseudoR^2^ of `r round(PseudoR2_QP14[1,1], 3)` and a dispersion parameter of `r round(sum(residuals(QPmod14, type="pearson")^2)/df.residual(QPmod14), 2)`.

```{r Crude-incidence-calculation_redone, echo = FALSE, include = FALSE}

# Adjust data frame to fit function
pred2 <- CompDat0 %>%
  mutate(ObsRatePer100000 = round(10^5 * .$Cases/.$Population, 1)) %>%
  mutate(ModelRatePer100000_QP = round(10^5 * predict(QPmod14, type = "response")/.$Population, 1)) %>%
  select(Island, District, Date, Year, Population, Cases, ObsRatePer100000, ModelRatePer100000_QP) %>%
  rename(., c("Observed Rates" = ObsRatePer100000, "Modelled Rates" = ModelRatePer100000_QP)) %>% 
  mutate("Pre_Post" = ifelse((.$Date >= "2012-04-01" & .$Date <= "2012-09-01"), "Pre", ifelse((.$Date >= "2013-04-01" & .$Date <= "2013-09-01" & .$Island == "Anjouan"), "Post", ifelse((.$Date >= "2014-04-01" & .$Date <= "2014-09-01" & .$Island == "Grande Comore"), "Post", "Excluded")))) %>%
  mutate("Treatment" = ifelse((.$District == "Mitsamiouli" | .$District == "Mbadjini-Est" | .$District == "Mbadjini-Ouest" | .$District == "Domoni" | .$District == "Pomoni"), "AP.PMQ", "AP")) %>%
  .[which(.$Pre_Post == "Pre" | .$Pre_Post == "Post"),]

# Grande Comore Island
# This gets used in the crudeIncidence()
Pops <- data.frame(District = (pred2[pred2$Island == "Grande Comore",]$District %>% droplevels(.) %>% levels(.)), Population = (pred2[pred2$Island == "Grande Comore",]$Population %>% unique(.)))

# Calculate crude incidence rates
capPREgci <- round(crudeIncidence(pred2[pred2$Island == "Grande Comore",], (pred2[pred2$Island == "Grande Comore",] %>% .[.$Treatment == "AP", ] %>% .$District %>% droplevels(.) %>% levels(.)), "Pre"), 2)
capPOSTgci <- round(crudeIncidence(pred2[pred2$Island == "Grande Comore",], (pred2[pred2$Island == "Grande Comore",] %>% .[.$Treatment == "AP", ] %>% .$District %>% droplevels(.) %>% levels(.)), "Post"), 2)

cappmqPREgci <- round(crudeIncidence(pred2[pred2$Island == "Grande Comore",], (pred2[pred2$Island == "Grande Comore",] %>% .[.$Treatment == "AP.PMQ", ] %>% .$District %>% droplevels(.) %>% levels(.)), "Pre"), 2)
cappmqPOSTgci <- round(crudeIncidence(pred2[pred2$Island == "Grande Comore",], (pred2[pred2$Island == "Grande Comore",] %>% .[.$Treatment == "AP.PMQ", ] %>% .$District %>% droplevels(.) %>% levels(.)), "Post"), 2)

# Anjouan Isalnd
# This gets used in the crudeIncidence()
Pops <- data.frame(District = (pred2[pred2$Island == "Anjouan",]$District %>% droplevels(.) %>% levels(.)), Population = (pred2[pred2$Island == "Anjouan",]$Population %>% unique(.)))

# Calculate crude incidence rates
capPREai <- round(crudeIncidence(pred2[pred2$Island == "Anjouan",], (pred2[pred2$Island == "Anjouan",] %>% .[.$Treatment == "AP", ] %>% .$District %>% droplevels(.) %>% levels(.)), "Pre"), 2)
capPOSTai <- round(crudeIncidence(pred2[pred2$Island == "Anjouan",], (pred2[pred2$Island == "Anjouan",] %>% .[.$Treatment == "AP", ] %>% .$District %>% droplevels(.) %>% levels(.)), "Post"), 2)

cappmqPREai <- round(crudeIncidence(pred2[pred2$Island == "Anjouan",], (pred2[pred2$Island == "Anjouan",] %>% .[.$Treatment == "AP.PMQ", ] %>% .$District %>% droplevels(.) %>% levels(.)), "Pre"), 2)
cappmqPOSTai <- round(crudeIncidence(pred2[pred2$Island == "Anjouan",], (pred2[pred2$Island == "Anjouan",] %>% .[.$Treatment == "AP.PMQ", ] %>% .$District %>% droplevels(.) %>% levels(.)), "Post"), 2) 
```

Our model recaptured the treatment effects for both AP only and AP+PMQ~LD~ on Anjouan Island as published [@Deng2018]. For Grande Comore Island, even with the reduced period length that was used for this model, the outcome reflected the same degree of incidence rate decline as with the longer periods. From the AP and AP+PMQ~LD~ treatment effects outcomes on the two Islands, we calculated an effectiveness of `r round(1 - C14_8[, "estimate"], 4)` (95% CI: `r round(1 - C14_8[, "upper"], 4)`, `r round(1 -  C14_8[, "lower"], 4)`) after three rounds of AP only on Anjouan Island vs. an effectiveness of `r round(1 - C14_2[, "estimate"], 4)` (95% CI: `r round(1 - C14_2[, "upper"], 4)`, `r round(1 -  C14_2[, "lower"], 4)`) after two rounds of AP only on Grande Comore;  similarly, we calculated an effectiveness of `r round(1 - C14_9[, "estimate"], 4)` (95% CI: `r round(1 - C14_9[, "upper"], 4)`, `r round(1 -  C14_9[, "lower"], 4)`) after three rounds of AP+PMQ~LD~ on Anjouan Island vs. an effectiveness of `r round(1 - C14_3[, "estimate"], 4)` (95% CI: `r round(1 - C14_3[, "upper"], 4)`, `r round(1 -  C14_3[, "lower"], 4)`) after two rounds of AP+PMQ~LD~ only on Grande Comore Island. To evaluate the residual malaria incidence rates after MDA, we found that post-treatment rates the three rounds of AP MDA on Anjouan Island were about `r round(C14_6[1, "estimate"], 2)`-fold (95% CI: `r round(C14_6[1, "lower"], 3)`, `r round(C14_6[1, "upper"], 3)`) lower than after two rounds of AP on Grande Comore, which was statistically significant (`r C14_6[1, "p.value"]`). Likewise, rates after three rounds of AP+PMQ~LD~ MDA on Anjuoan Island were calculated to be `r round(C14_7[1, "estimate"], 2)`-fold (95% CI: `r round(C14_7[1, "lower"], 3)`, `r round(C14_7[1, "upper"], 3)`) lower than after the two-round regimen on Grande Comore Island, which was not statistically significant, though (`r C14_7[1, "p.value"]`). However, we note that the residual malaria incidence rates on Grande Comore Island reflected reductions from `r round(capPREgci / capPREai, 1)`-fold (AP) and `r round(cappmqPREgci / cappmqPREai, 0)`-fold (AP+PMQ~LD~) higher pre-MDA rates, respectively, than did the reductions from pre-MDA rates on Anjouan Island based on crude average monthly incidence rates per 100,000 people (pre-AP MDA: `r round(capPREgci, 1)` vs `r round(capPREai, 1)`, and pre-AP+PMQ~LD~ MDA: `r round(cappmqPREgci, 1)` vs `r round(cappmqPREai, 1)` [Grande Comore Island vs Anjouan Island]; see also Fig. 11). 

```{r QPtab14-Output, echo = FALSE, include = TRUE}
QPtab14$table[c("AP", "AP.PMQ", "AP_AI", "AP.PMQ_AI", "PRE"),]
```

```{r Calculate-model-incidence-both-islands, echo = FALSE, include = FALSE}
# Adding modeled incidence data to the data table
DatOut2 <- CompDat0 %>%
  mutate(ObsRatePer100000 = round(10^5 * .$Cases/.$Population, 1)) %>%
  mutate(ModelRatePer100000 = round(10^5 * predict(QPmod14, type = "response")/.$Population, 1)) %>%
  mutate(Date = format(.$Date, "%b %Y")) %>%
  select(Island, District, Date, Month_1, Year, Population, Cases, ObsRatePer100000, ModelRatePer100000) %>%
  rename(., c("Observed Rates" = ObsRatePer100000, "Modelled Rates" = ModelRatePer100000)) %>%
  .[!(.$Year == 2012 & .$Island == "Grande Comore"), ] %>%
  mutate("Pseudo_Year" = ifelse(.$Island == "Grande Comore" & .$Year == 2013 | .$Island == "Anjouan" & .$Year == 2012, "00", "01")) %>%
  mutate("Pseudo Time (Months)" = as.Date(paste("1", Month_1, Pseudo_Year), format = "%d %b %Y"))

# Reformating DatOut for the graph
DatOut3 <- DatOut2 %>% 
  select(Island, District, Date, `Pseudo Time (Months)`, Population, Cases) %>%
  group_by(Island, `Pseudo Time (Months)`) %>%
  summarise("Population" = sum(Population), "Cases" = sum(Cases)) %>%
  as.data.frame(.) %>%
  mutate("Incidence Rates / 100,000" = round(10^5 * .$Cases/.$Population, 1))
```

While relatively well matched in terms of total population (Anjouan Island: `r formatC(tail(DatOut3, 1)$Population, format="d", big.mark=",")`; Grande Comore Island: `r formatC(head(DatOut3, 1)$Population, format="d", big.mark=",")`), one must keep in mind that Anjouan and Grande Comore Islands are quite different from one another not only in pre-MDA malaria incidence rates, but also in other features including climate, topography, and vector populations. A more comprehensive comparison would require additional information on these and other variables. Nevertheless, it is clear that on both islands substantial reductions in malaria incidence were observed post-MDA with both forms of MDA, and malaria incidence rates stayed low for several years until the end of the study periods.

```{r Fig-11, echo = FALSE, include = TRUE, fig.height = 2.5, fig.width = 6,  fig.cap = "Comparing Anjouan Island incidence rates pre- and post-treatment to those of Grande Comore Island"}
# Graph of Observed and Modelled incidence data
# png(filename="Modelled vs Observed Rates (Year).jpeg", width=1200, height=1200)

ggplot(DatOut3, aes(x = `Pseudo Time (Months)`, y = `Incidence Rates / 100,000`, group = `Island`)) + 
  geom_line(aes(color = `Island`), linewidth = 1) + 
  theme(strip.text.y = element_text(angle = 0)) +
  # geom_vline(xintercept = as.numeric(DatOut1$Date[65]), linetype=4, colour="black") +
  scale_x_date(date_breaks = "1 month", date_labels = "%b %y") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1), text = element_text(size = 10))

# dev.off()

### Compare Pre- to Post-Treatment

```

# Analysis of parasite prevalence in children <10 years of age pre- and post-MDA

## Analysis of the effect of MDA on parasitemia prevalence

```{r Parasite-Prevalence-analyzed-by-RDT-by-Treatment, echo = FALSE, include = FALSE}
# Data loading
DatX <- read_all2("Parasite prevalence in children.xlsx")

# Data arrangement for analysis
DatY <- DatX[[1]] %>%
  mutate(across(where(is.character), as.factor)) %>%
  mutate("AP" = ifelse(.$Treatment == "AP" & .$Time == "2_Months_post_MDA", 1, 
                       ifelse(.$Treatment == "AP" & .$Time == "7_Months_post_MDA", 1,
                              ifelse(.$Treatment == "AP" & .$Time == "18_Months_post_MDA", 1, 0))),
         "AP.PMQ" = ifelse(.$Treatment == "AP+PMQLD" & .$Time == "2_Months_post_MDA", 1, 
                       ifelse(.$Treatment == "AP+PMQLD" & .$Time == "7_Months_post_MDA", 1,
                              ifelse(.$Treatment == "AP+PMQLD" & .$Time == "18_Months_post_MDA", 1, 0))))

# Dispersion test for model selection
# By district
Mod15 <- glm(Parasite_Positive ~ District + AP + AP.PMQ + offset(log(Surveyed)), family = poisson, data = DatY) # Poisson model to execute dispersion test to select right model
AssTst2 <- dispersiontest(Mod15, alternative = "two.sided") # dispersion test to check for validity of Poisson model

if ((AssTst2$p.value < 0.05) == TRUE) {
  if ((dispersiontest(Mod15 , alternative = "greater")$p.value < 0.05) == TRUE) {
    # Quasi-Poisson model
    Mod15 <- glm(Parasite_Positive ~ District + AP + AP.PMQ + offset(log(Surveyed)), family = quasipoisson, data = DatY)
    # Output table with exp() coefficents
    Tab15 <- glmTable(Mod15)
    # Model name
    Mod15Nam <- "quasi-Poisson"
    # PseudoR^2
    PseudoR2_QP15 <- glance(Mod15) %>%
      summarise(PreudoR2 = 1 - deviance / null.deviance) %>%
      cbind(., ID = "Pre- vs Post-Treatment") %>%
      set_rownames(.$ID) %>%
      select(., -ID)
  } else {
    # Generalized Poisson model
    Mod15 <- glmmTMB(Parasite_Positive ~ District + AP + AP.PMQ + offset(log(Surveyed)), family = compois, data = DatY)
    # Output table with exp() coefficents
    Tab15 <- vglmTable(Mod15)
    # Model name
    Mod15Nam <- "Conway-Maxwell Poisson"
    # PseudoR^2
    PseudoR2_QP15 <- attr(r.squaredLR(Mod15, 
                          null = glmmTMB(Parasite_Positive ~ 1 + offset(log(Surveyed)), family = compois, data = DatY)), 
                          "adj.r.squared")
  }
} else {
  # Poisson model is kept
  # Output table with exp() coefficents
  Tab15 <- glmTable(Mod15)
  # Model name
  Mod15Nam <- "Poisson"
  # PseudoR^2
  PseudoR2_QP15 <- glance(Mod15) %>%
      summarise(PreudoR2 = 1 - deviance / null.deviance) %>%
      cbind(., ID = "Pre- vs Post-Treatment") %>%
      set_rownames(.$ID) %>%
      select(., -ID)
}
summary(Mod15)
```

```{r Wald-test-for-contrast-between-treatment-outcomes-for-parasitemia, echo = FALSE, include = FALSE}
if (Mod15Nam == "Conway-Maxwell Poisson") {
  # AP.PMQ_AI vs PRE (Manual calculation, because contrast did not work)
  Cb <- tail(head(Mod15$fit$par, -1), - length(unique(DatY$District)))[2] + -1 * tail(head(Mod15$fit$par, -1), -length(unique(DatY$District)))[1] # Subtracts model coefficients (AP.PMQ - AP)
  
  C15_AP <- matrix(c(0,0,0,0,0,0,1,0,0), 1) # Only get variance of AP
  C15AP.PMQ <- matrix(c(0,0,0,0,0,0,0,1,0), 1) # Only get variance of AP
  varCb <- C15_AP %*% vcov(Mod15)$cond %*% t(C15_AP) - C15AP.PMQ %*% vcov(Mod15)$cond %*% t(C15AP.PMQ) # Use inverse value for second term; when adding/subtracting means, their variance is additive
  
  # Collate output data from comparison
  C15_1 <- data.frame(estimate = round(exp(Cb), 5),
                      lower = round(exp(Cb - qnorm(.975) * sqrt(varCb)), 5),
                      upper = round(exp(Cb + qnorm(.975) * sqrt(varCb)), 5),
                      p.value = write.p(2 * (1 - pt(abs(Cb/sqrt(varCb)), df = Inf)), 4),
                      f125 = varCb / ((log(1.25) - Cb) / qnorm(.975))^2,
                      f80 = varCb / ((-log(.8) + Cb) / qnorm(.975))^2, 
                      Cb = Cb, 
                    varCb = varCb)
} else {
  C15_1 <- Contrasts(matrix(c(0,0,0,0,0,0,0,-1,1), 1), Mod15) # AP.PMQ vs AP
}



# Comparing treatment outcomes by MDA (1 = no difference)
(Tab15$table["AP.PMQ", "Estimate"] / Tab15$table["AP", "Estimate"])
C15_1["estimate"]
```

Since children <10 years of age are a particularly vulnerable group for severe malaria, we surveyed prevalence of detectable parasitemia in this age group in all seven districts on Grande Comore Island by examining for the presence of asexual-stage parasites (Table 3) or gametocytes (Supplementary Table 3) by RDT or microscopy, respectively, in randomly selected children up to 11 months prior pre-MDA or once at either up to 2, 7, or 18 months post-MDA, which made these unpaired datasets. We first analyzed the RDT-data. To selected an appropriate model, we first checked whether data dispersion was significantly larger (overdispersed) or smaller (underdispersed) than 1 (dispersion parameter: `r round(AssTst2$estimate, 3)`, `r ifelse(AssTst2$p.value >= 0.00001, paste0("p=", round(AssTst2$p.value, 5)), paste0("p<0.00001"))`). Based on the test result, we selected a `r Mod15Nam` model to analyze how either MDA affected parasitemia prevalence. 

$$
\begin{gathered}
glmmTMB(ParasitePositive \sim District + AP + AP.PMQ + \\
offset(log(Surveyed)), family = compois, data = data)
\end{gathered}
$$

Parasite positive cases were used as the dependent variable, while Districts and treatments (AP and AP+PMQ~LD~) served as predictors. Since the number of surveyed kids varied between districts and time-points, we offset by the the number of surveyed kids, which meant that we were modeling rates rather than counts. The pseudoR^2^ for the model was `r round(PseudoR2_QP15,3)`. The results showed that MDA with AP only or AP+PMQ~LD~ resulted in an average remainder of `r round(Tab15$table["AP", "Estimate"] * 100, 2)`% (95% CI: `r round(Tab15$table["AP", "lower95pctCL"] * 100, 2)`%, `r round(Tab15$table["AP", "upper95pctCL"] * 100, 2)`%, `r Tab15$table["AP", "p.value"]`) and `r round(Tab15$table["AP.PMQ", "Estimate"] * 100, 2)`% (95% CI: `r round(Tab15$table["AP.PMQ", "lower95pctCL"] * 100, 2)`%, `r round(Tab15$table["AP.PMQ", "upper95pctCL"] * 100, 2)`%, `r Tab15$table["AP.PMQ", "p.value"]`) of the pre-treatment parasitemia prevalence rate, respectively, which was statistically significant. The ratio of those rate ratios was `r round(Tab15$table["AP.PMQ", "Estimate"], 4)` / `r round(Tab15$table["AP", "Estimate"], 4)` = `r round(C15_1["estimate"], 4)` (95% CI: `r round(C15_1["lower"], 4)`, `r round(C15_1["upper"], 4)`; `r C15_1["p.value"]`), indicating that both, AP only and AP+PMQ~LD~ MDA, were equally effective. To have enough precision to be 95% confident that the ratio of rate ratios was within the range [0.80, 1.25], we would only need to repeat the experiment about `r round(C15_1[, "f125"], 0)` times, assuming we achieved the same estimate of the ratio and its variance.

```{r Tab15-Output, echo = FALSE, include = TRUE}
Tab15$table[c("AP", "AP.PMQ"),]
```

```{r Parasite-Prevalence-analyzed-by-RDT-by-time-point-ref-Pre, echo = FALSE, include = FALSE}

DatY_1 <- within(DatY, Time <- relevel(Time, ref = "11_Months_Pre_MDA")) # Changing reference to pre-MDA

# Dispersion test for model selection
# By treatment group
Mod16 <- glm(Parasite_Positive ~ Treatment + Time + offset(log(Surveyed)), family = poisson, data = DatY_1) # Poisson model to execute dispersion test to select right model
AssTst3 <- dispersiontest(Mod16 , alternative = "two.sided") # dispersion test to check for validity of Poisson model

if ((AssTst3$p.value < 0.05) == TRUE) {
  if ((dispersiontest(Mod16 , alternative = "greater")$p.value < 0.05) == TRUE) {
    # Quasi-Poisson model
    Mod16 <- glm(Parasite_Positive ~ Treatment + Time + offset(log(Surveyed)), family = quasipoisson, data = DatY_1)
    # Output table with exp() coefficents
    Tab16 <- glmTable(Mod16)
    # Model name
    Mod16Nam <- "quasi-Poisson"
    # PseudoR^2
    PseudoR2_QP16 <- glance(Mod16) %>%
      summarise(PreudoR2 = 1 - deviance / null.deviance) %>%
      cbind(., ID = "Pre- vs Post-Treatment") %>%
      set_rownames(.$ID) %>%
      select(., -ID)
  } else {
    # Generalized Poisson model
    Mod16 <- glmmTMB(Parasite_Positive ~ Treatment + Time + offset(log(Surveyed)), family = compois, data = DatY_1)
    # Output table with exp() coefficents
    Tab16 <- vglmTable(Mod16)
    # Model name
    Mod16Nam <- "Conway-Maxwell Poisson"
    # PseudoR^2
    PseudoR2_QP16 <- attr(r.squaredLR(Mod16, 
                          null = glmmTMB(Parasite_Positive ~ 1 + offset(log(Surveyed)), family = genpois, data = DatY_1)), 
                          "adj.r.squared")
  }
} else {
  # Poisson model is kept
  # Output table with exp() coefficents
  Tab16 <- glmTable(Mod16)
  # Model name
  Mod16Nam <- "Poisson"
  # PseudoR^2
  PseudoR2_QP16 <- glance(Mod16) %>%
      summarise(PreudoR2 = 1 - deviance / null.deviance) %>%
      cbind(., ID = "Pre- vs Post-Treatment") %>%
      set_rownames(.$ID) %>%
      select(., -ID)
}
summary(Mod16)
```

```{r Parasite-Prevalence-analyzed-by-RDT-by-time-point-ref-6-Months, echo = FALSE, include = FALSE}

DatY_2 <- within(DatY, Time <- relevel(Time, ref = "2_Months_post_MDA")) # Changing reference to pre-MDA

# Dispersion test for model selection
# By treatment group
Mod19 <- glm(Parasite_Positive ~ Treatment + Time + offset(log(Surveyed)), family = poisson, data = DatY_2) # Poisson model to execute dispersion test to select right model
AssTst6 <- dispersiontest(Mod19 , alternative = "two.sided") # dispersion test to check for validity of Poisson model

if ((AssTst3$p.value < 0.05) == TRUE) {
  if ((dispersiontest(Mod19 , alternative = "greater")$p.value < 0.05) == TRUE) {
    # Quasi-Poisson model
    Mod19 <- glm(Parasite_Positive ~ Treatment + Time + offset(log(Surveyed)), family = quasipoisson, data = DatY_2)
    # Output table with exp() coefficents
    Tab19 <- glmTable(Mod19)
    # Model name
    Mod19Nam <- "quasi-Poisson"
    # PseudoR^2
    PseudoR2_QP19 <- glance(Mod19) %>%
      summarise(PreudoR2 = 1 - deviance / null.deviance) %>%
      cbind(., ID = "Pre- vs Post-Treatment") %>%
      set_rownames(.$ID) %>%
      select(., -ID)
  } else {
    # Generalized Poisson model
    Mod19 <- glmmTMB(Parasite_Positive ~ Treatment + Time + offset(log(Surveyed)), family = compois, data = DatY_2)
    # Output table with exp() coefficents
    Tab19 <- vglmTable(Mod19)
    # Model name
    Mod19Nam <- "Conway-Maxwell Poisson"
    # PseudoR^2
    PseudoR2_QP19 <- attr(r.squaredLR(Mod19, 
                          null = glmmTMB(Parasite_Positive ~ 1 + offset(log(Surveyed)), family = genpois, data = DatY_2)), 
                          "adj.r.squared")
  }
} else {
  # Poisson model is kept
  # Output table with exp() coefficents
  Tab19 <- glmTable(Mod19)
  # Model name
  Mod19Nam <- "Poisson"
  # PseudoR^2
  PseudoR2_QP19 <- glance(Mod19) %>%
      summarise(PreudoR2 = 1 - deviance / null.deviance) %>%
      cbind(., ID = "Pre- vs Post-Treatment") %>%
      set_rownames(.$ID) %>%
      select(., -ID)
}
summary(Mod19)
```

Therefore, when we looked at the prevalence rates for each post-treatment time-point compared to pre-treatment, we did not distinguish between MDAs. We selected a `r Mod16Nam` model to analyze the rate of parasitemia prevalence reduction by time-point (pseudoR^2^: `r round(PseudoR2_QP16[1,1],3)`) based on the same criteria as above (dispersion parameter: `r round(AssTst3$estimate, 3)`, `r ifelse(AssTst3$p.value >= 0.00001, paste0("p=", round(AssTst3$p.value, 5)), paste0("p<0.00001"))`). 

$$
glm(ParasitePositive \sim Treatment + Time + offset(log(Surveyed)), family = poisson, data = data)
$$

The results showed that parasitemia prevalence rates were statistically significantly reduced for each time point, showing only `r round(Tab16$table[rownames(Tab16$table) %like% "2", "Estimate"] * 100, 2)`% (95% CI: `r round(Tab16$table[rownames(Tab16$table) %like% "2", "lower95pctCL"] * 100, 2)`%, `r round(Tab16$table[rownames(Tab16$table) %like% "2", "upper95pctCL"] * 100, 2)`%, `r Tab16$table[rownames(Tab16$table) %like% "2", "p.value"]`) at 2 month post-MDA, `r round(Tab16$table[rownames(Tab16$table) %like% "7", "Estimate"] * 100, 2)`% (95% CI: `r round(Tab16$table[rownames(Tab16$table) %like% "7", "lower95pctCL"] * 100, 2)`%, `r round(Tab16$table[rownames(Tab16$table) %like% "7", "upper95pctCL"] * 100, 2)`%, `r Tab16$table[rownames(Tab16$table) %like% "7", "p.value"]`) at 7 month post-MDA, and `r round(Tab16$table[rownames(Tab16$table) %like% "18", "Estimate"] * 100, 2)`% (95% CI: `r round(Tab16$table[rownames(Tab16$table) %like% "18", "lower95pctCL"] * 100, 2)`%, `r round(Tab16$table[rownames(Tab16$table) %like% "18", "upper95pctCL"] * 100, 2)`%, `r Tab16$table[rownames(Tab16$table) %like% "18", "p.value"]`) 18 months post-MDA of pre-MDA prevalence rates. It is important to note that all time points post-MDA covered parts of the wet season, when malaria incidence was at its highest pre-MDA; yet parasitemia prevalence was markedly reduced during the wet season and declined marginally further until our final time point at 18 months post-MDA, but not statistically significantly compared to 2 month post-MDA (vs 7 month post-MDA: `r round(Tab19$table[rownames(Tab19$table) %like% "7", "Estimate"], 4)` (95% CI: `r round(Tab19$table[rownames(Tab19$table) %like% "7", "lower95pctCL"], 4)`, `r round(Tab19$table[rownames(Tab19$table) %like% "7", "upper95pctCL"], 4)`, `r Tab19$table[rownames(Tab19$table) %like% "7", "p.value"]`); vs 18 months post-MDA: `r round(Tab19$table[rownames(Tab19$table) %like% "18", "Estimate"], 4)` (95% CI: `r round(Tab19$table[rownames(Tab19$table) %like% "18", "lower95pctCL"], 4)`, `r round(Tab19$table[rownames(Tab19$table) %like% "18", "upper95pctCL"], 4)`, `r Tab19$table[rownames(Tab19$table) %like% "18", "p.value"]`)).

```{r Tab16-Output, echo = FALSE, include = TRUE}
rbind(Tab16$table[2, ],
  set_rownames(data.frame("-", "-", "-", "-"), "Compared to 11_Months_Pre_MDA") %>%
    setNames(., colnames(Tab16$table)),
    Tab16$table[c(3:5), ] %>%
      rownames_to_column(.) %>%
      set_rownames(.,c(3,1,2)) %>%
      .[order(row.names(.)), ] %>%
      remove_rownames(.) %>%
      column_to_rownames(., var = "rowname"),
    set_rownames(data.frame("-", "-", "-", "-"), "Compared to 2_Months_post_MDA") %>%
      setNames(., colnames(Tab16$table)),
    Tab19$table[rownames(Tab19$table) %like% "7" | rownames(Tab19$table) %like% "18",] %>%
    rownames_to_column(.) %>%
      set_rownames(.,c(2,1)) %>%
      .[order(row.names(.)), ] %>%
      remove_rownames(.) %>%
      column_to_rownames(., var = "rowname"))
```

## Analysis of the effect of MDA on gametocyte prevalence

```{r Parasite-Prevalence-analyzed-by-Microscopy-by-treatment, echo = FALSE, include = FALSE}
# Data arrangement for analysis
DatZ <- DatX[[2]] %>%
  mutate(across(where(is.character), as.factor)) %>%
  mutate("AP" = ifelse(.$Treatment == "AP" & .$Time == "2_Months_post_MDA", 1, 
                       ifelse(.$Treatment == "AP" & .$Time == "7_Months_post_MDA", 1,
                              ifelse(.$Treatment == "AP" & .$Time == "18_Months_post_MDA", 1, 0))),
         "AP.PMQ" = ifelse(.$Treatment == "AP+PMQLD" & .$Time == "2_Months_post_MDA", 1, 
                       ifelse(.$Treatment == "AP+PMQLD" & .$Time == "7_Months_post_MDA", 1,
                              ifelse(.$Treatment == "AP+PMQLD" & .$Time == "18_Months_post_MDA", 1, 0)))) 

# Dispersion test for model selection
# Note that by district will not converge due to too many zeros and ones
# By treatment group
Mod17 <- glm(Parasite_Positive ~ District + AP + AP.PMQ + offset(log(Surveyed)), family = poisson, data = DatZ) # Poisson model to execute dispersion test to select right model
AssTst4 <- dispersiontest(Mod17 , alternative = "two.sided") # dispersion test to check for validity of Poisson model

if ((AssTst4$p.value < 0.05) == TRUE) {
  if ((dispersiontest(Mod17 , alternative = "greater")$p.value < 0.05) == TRUE) {
    # Quasi-Poisson model
    Mod17 <- glm(Parasite_Positive ~ District + AP + AP.PMQ + offset(log(Surveyed)), family = quasipoisson, data = DatZ)
    # Output table with exp() coefficents
    Tab17 <- glmTable(Mod17)
    # Model name
    Mod17Nam <- "quasi-Poisson"
    # PseudoR^2
    PseudoR2_QP17 <- glance(Mod17) %>%
      summarise(PreudoR2 = 1 - deviance / null.deviance) %>%
      cbind(., ID = "Pre- vs Post-Treatment") %>%
      set_rownames(.$ID) %>%
      select(., -ID)
  } else {
    # Generalized Poisson model
    Mod17 <- glmmTMB(Parasite_Positive ~ District + AP + AP.PMQ + offset(log(Surveyed)), family = compois, data = DatZ)
    # Output table with exp() coefficents
    Tab17 <- vglmTable(Mod17)
    # Model name
    Mod17Nam <- "Conway-Maxwell Poisson"
    # PseudoR^2
    PseudoR2_QP17 <- attr(r.squaredLR(Mod17, 
                          null = glmmTMB(Parasite_Positive ~ 1 + offset(log(Surveyed)), family = compois, data = DatZ)), 
                          "adj.r.squared")
  }
} else {
  # Poisson model is kept
  # Output table with exp() coefficents
  Tab17 <- glmTable(Mod17)
  # Model name
  Mod17Nam <- "Poisson"
  # PseudoR^2
  PseudoR2_QP17 <- glance(Mod17) %>%
      summarise(PreudoR2 = 1 - deviance / null.deviance) %>%
      cbind(., ID = "Pre- vs Post-Treatment") %>%
      set_rownames(.$ID) %>%
      select(., -ID)
}
summary(Mod17)
```

```{r Wald-test-for-contrast-between-treatment-outcomes-for-gametocytemia, echo = FALSE, include = FALSE}
if (Mod17Nam == "Conway-Maxwell Poisson") {
  # AP.PMQ_AI vs PRE (Manual calculation, because contrast did not work)
  Cb <- tail(head(Mod17$fit$par, -1), -length(unique(DatZ$District)))[2] + -1 * tail(head(Mod17$fit$par, -1), -length(unique(DatZ$District)))[1] # Subtracts model coefficients (AP.PMQ - AP)
  
  C17_AP <- matrix(c(0,0,0,0,0,0,1,0,0), 1) # Only get variance of AP
  C17AP.PMQ <- matrix(c(0,0,0,0,0,0,0,1,0), 1) # Only get variance of AP
  varCb <- C17_AP %*% vcov(Mod17)$cond %*% t(C17_AP) - C17AP.PMQ %*% vcov(Mod17)$cond %*% t(C17AP.PMQ) # Use inverse value for second term; when adding/subtracting means, their variance is additive
  
  # Collate output data from comparison
  C17_1 <- data.frame(estimate = round(exp(Cb), 5),
                      lower = round(exp(Cb - qnorm(.975) * sqrt(varCb)), 5),
                      upper = round(exp(Cb + qnorm(.975) * sqrt(varCb)), 5),
                      p.value = write.p(2 * (1 - pt(abs(Cb/sqrt(varCb)), df = Inf)), 4),
                      f125 = varCb / ((log(1.25) - Cb) / qnorm(.975))^2,
                      f80 = varCb / ((-log(.8) + Cb) / qnorm(.975))^2, 
                      Cb = Cb, 
                      varCb = varCb)
} else {
  C17_1 <- Contrasts(matrix(c(0,0,0,0,0,0,0,-1,1), 1), Mod15) # AP.PMQ vs AP
}

# Comparing treatment outcomes by MDA (1 = no difference)
(Tab17$table["AP.PMQ", "Estimate"] / Tab17$table["AP", "Estimate"])
 C17_1["estimate"]
```

We used the same approach as above for the analysis of the gametocyte prevalence according to microscopy. We selected a `r Mod17Nam` model to analyze the rate of gametocyte prevalence reduction by time-point (pseudoR^2^: `r round(PseudoR2_QP17,3)`) based on the same criteria as above (dispersion parameter: `r round(AssTst4$estimate, 3)`, `r ifelse(AssTst4$p.value >= 0.00001, paste0("p=", round(AssTst4$p.value, 5)), paste0("p<0.00001"))`). The results showed that MDA with AP only or AP+PMQ~LD~ resulted in an average remainder of `r round(Tab17$table["AP", "Estimate"] * 100, 2)`% (95% CI: `r round(Tab17$table["AP", "lower95pctCL"] * 100, 2)`%, `r round(Tab17$table["AP", "upper95pctCL"] * 100, 2)`%, `r Tab17$table["AP", "p.value"]`) and `r round(Tab17$table["AP.PMQ", "Estimate"] * 100, 2)`% (95% CI: `r round(Tab17$table["AP.PMQ", "lower95pctCL"] * 100, 2)`%, `r round(Tab17$table["AP.PMQ", "upper95pctCL"] * 100, 2)`%, `r Tab17$table["AP.PMQ", "p.value"]`) of the pre-treatment gametocyte prevalence rate, respectively, which was statistically significant. The ratio of those rate ratios was `r round(Tab17$table["AP.PMQ", "Estimate"], 4)` / `r round(Tab17$table["AP", "Estimate"], 4)` = `r round(C17_1["estimate"], 4)` (95% CI: `r round(C17_1["lower"], 4)`, `r round(C17_1["upper"], 4)`; `r C17_1["p.value"]`), indicating that both, AP only and AP+PMQ~LD~ MDA, were equally effective. However, to have enough precision to be 95% confident that the ratio of rate ratios was within the range [0.80, 1.25], we would need to repeat the experiment about `r round(C17_1[, "f80"], 0)` times, assuming we achieved the same estimate of the ratio and its variance.

```{r Tab17-Output, echo = FALSE, include = TRUE}
Tab17$table[c("AP", "AP.PMQ"),]
```

```{r Parasite-Prevalence-analyzed-by-Microscopy-by-timepoint-ref-Pre, echo = FALSE, include = FALSE}

DatZ_1 <- within(DatZ, Time <- relevel(Time, ref = "11_Months_Pre_MDA")) # Changing reference to pre-MDA

# Dispersion test for model selection
# Note that by district will not converge due to too many zeros and ones
# By treatment group
Mod18 <- glm(Parasite_Positive ~ Treatment + Time + offset(log(Surveyed)), family = poisson, data = DatZ_1) # Poisson model to execute dispersion test to select right model
AssTst5 <- dispersiontest(Mod18 , alternative = "two.sided") # dispersion test to check for validity of Poisson model

if ((AssTst4$p.value < 0.05) == TRUE) {
  if ((dispersiontest(Mod18 , alternative = "greater")$p.value < 0.05) == TRUE) {
    # Quasi-Poisson model
    Mod18 <- glm(Parasite_Positive ~ Treatment + Time + offset(log(Surveyed)), family = quasipoisson, data = DatZ_1)
    # Output table with exp() coefficents
    Tab18 <- glmTable(Mod18)
    # Model name
    Mod18Nam <- "quasi-Poisson"
    # PseudoR^2
    PseudoR2_QP18 <- glance(Mod18) %>%
      summarise(PreudoR2 = 1 - deviance / null.deviance) %>%
      cbind(., ID = "Pre- vs Post-Treatment") %>%
      set_rownames(.$ID) %>%
      select(., -ID)
  } else {
    # Generalized Poisson model
    Mod18 <- glmmTMB(Parasite_Positive ~ Treatment + Time + offset(log(Surveyed)), family = compois, data = DatZ_1)
    # Output table with exp() coefficents
    Tab18 <- vglmTable(Mod18)
    # Model name
    Mod18Nam <- "Conway-Maxwell Poisson"
    # PseudoR^2
    PseudoR2_QP18 <- attr(r.squaredLR(Mod18, 
                          null = glmmTMB(Parasite_Positive ~ 1 + offset(log(Surveyed)), family = genpois, data = DatY_1)), 
                          "adj.r.squared")
  }
} else {
  # Poisson model is kept
  # Output table with exp() coefficents
  Tab18 <- glmTable(Mod18)
  # Model name
  Mod18Nam <- "Poisson"
  # PseudoR^2
  PseudoR2_QP18 <- glance(Mod18) %>%
      summarise(PreudoR2 = 1 - deviance / null.deviance) %>%
      cbind(., ID = "Pre- vs Post-Treatment") %>%
      set_rownames(.$ID) %>%
      select(., -ID)
}
summary(Mod18)
```

```{r Parasite-Prevalence-analyzed-by-Microscopy-by-timepoint-ref-6-Months, echo = FALSE, include = FALSE}

DatZ_2 <- within(DatZ, Time <- relevel(Time, ref = "2_Months_post_MDA")) # Changing reference to pre-MDA

# Dispersion test for model selection
# Note that by district will not converge due to too many zeros and ones
# By treatment group
Mod20 <- glm(Parasite_Positive ~ Treatment + Time + offset(log(Surveyed)), family = poisson, data = DatZ_2) # Poisson model to execute dispersion test to select right model
AssTst7 <- dispersiontest(Mod20 , alternative = "two.sided") # dispersion test to check for validity of Poisson model

if ((AssTst4$p.value < 0.05) == TRUE) {
  if ((dispersiontest(Mod20 , alternative = "greater")$p.value < 0.05) == TRUE) {
    # Quasi-Poisson model
    Mod20 <- glm(Parasite_Positive ~ Treatment + Time + offset(log(Surveyed)), family = quasipoisson, data = DatZ_2)
    # Output table with exp() coefficents
    Tab20 <- glmTable(Mod20)
    # Model name
    Mod20Nam <- "quasi-Poisson"
    # PseudoR^2
    PseudoR2_QP20 <- glance(Mod20) %>%
      summarise(PreudoR2 = 1 - deviance / null.deviance) %>%
      cbind(., ID = "Pre- vs Post-Treatment") %>%
      set_rownames(.$ID) %>%
      select(., -ID)
  } else {
    # Generalized Poisson model
    Mod20 <- glmmTMB(Parasite_Positive ~ Treatment + Time + offset(log(Surveyed)), family = compois, data = DatZ_2)
    # Output table with exp() coefficents
    Tab20 <- vglmTable(Mod20)
    # Model name
    Mod20Nam <- "Conway-Maxwell Poisson"
    # PseudoR^2
    PseudoR2_QP20 <- attr(r.squaredLR(Mod20, 
                          null = glmmTMB(Parasite_Positive ~ 1 + offset(log(Surveyed)), family = genpois, data = DatY_1)), 
                          "adj.r.squared")
  }
} else {
  # Poisson model is kept
  # Output table with exp() coefficents
  Tab20 <- glmTable(Mod20)
  # Model name
  Mod20Nam <- "Poisson"
  # PseudoR^2
  PseudoR2_QP20 <- glance(Mod20) %>%
      summarise(PreudoR2 = 1 - deviance / null.deviance) %>%
      cbind(., ID = "Pre- vs Post-Treatment") %>%
      set_rownames(.$ID) %>%
      select(., -ID)
}
summary(Mod20)
```

As with the RDT data, when we looked at the prevalence rates for each post-treatment time-point compared to pre-treatment, we did not distinguish between MDAs. We selected a `r Mod18Nam` model to analyze the rate of gametocyte prevalence reduction by time-point (pseudoR^2^: `r round(PseudoR2_QP18,3)`) based on the same criteria as above (dispersion parameter: `r round(AssTst4$estimate, 3)`, `r ifelse(AssTst4$p.value >= 0.00001, paste0("p=", round(AssTst4$p.value, 5)), paste0("p<0.00001"))`). The results showed that gametocyte prevalence rates were statistically significantly reduced for each time point, showing only `r round(Tab18$table[rownames(Tab18$table) %like% "2", "Estimate"] * 100, 2)`% (95% CI: `r round(Tab18$table[rownames(Tab18$table) %like% "2", "lower95pctCL"] * 100, 2)`%, `r round(Tab18$table[rownames(Tab18$table) %like% "2", "upper95pctCL"] * 100, 2)`%, `r Tab18$table[rownames(Tab18$table) %like% "2", "p.value"]`) at 2 month post-MDA, `r round(Tab18$table[rownames(Tab18$table) %like% "7", "Estimate"] * 100, 2)`% (95% CI: `r round(Tab18$table[rownames(Tab18$table) %like% "7", "lower95pctCL"] * 100, 2)`%, `r round(Tab18$table[rownames(Tab18$table) %like% "7", "upper95pctCL"] * 100, 2)`%, `r Tab18$table[rownames(Tab18$table) %like% "7", "p.value"]`) at 7 month post-MDA, and `r round(Tab18$table[rownames(Tab18$table) %like% "18", "Estimate"] * 100, 2)`% (95% CI: `r round(Tab18$table[rownames(Tab18$table) %like% "18", "lower95pctCL"] * 100, 2)`%, `r round(Tab18$table[rownames(Tab18$table) %like% "18", "upper95pctCL"] * 100, 2)`%, `r Tab18$table[rownames(Tab18$table) %like% "18", "p.value"]`) 18 months post-MDA of pre-MDA prevalence rates. Please, note that gametocyte prevalence rates were less dramatically reduced at 2 months post-MDA, than parasitemia prevalence rates, which may have been a reflection of the already low prevalence of gametocytes pre-MDA. However, gametocyte prevalence rates were statistically significantly further reduced at 7 (`r round(Tab20$table[rownames(Tab20$table) %like% "7", "Estimate"], 4)` (95% CI: `r round(Tab20$table[rownames(Tab20$table) %like% "7", "lower95pctCL"], 4)`, `r round(Tab20$table[rownames(Tab20$table) %like% "7", "upper95pctCL"], 4)`, `r Tab20$table[rownames(Tab20$table) %like% "7", "p.value"]`)) and 18 months post-MDA (`r round(Tab20$table[rownames(Tab20$table) %like% "18", "Estimate"], 4)` (95% CI: `r round(Tab20$table[rownames(Tab20$table) %like% "18", "lower95pctCL"], 4)`, `r round(Tab20$table[rownames(Tab20$table) %like% "18", "upper95pctCL"], 4)`, `r Tab20$table[rownames(Tab20$table) %like% "18", "p.value"]`)).

```{r QPtab18-Output, echo = FALSE, include = TRUE}
rbind(Tab18$table[2, ],
  set_rownames(data.frame("-", "-", "-", "-"), "Compared to 11_Months_Pre_MDA") %>%
    setNames(., colnames(Tab18$table)),
    Tab18$table[c(3:5), ] %>%
      rownames_to_column(.) %>%
      set_rownames(.,c(3,1,2)) %>%
      .[order(row.names(.)), ] %>%
      remove_rownames(.) %>%
      column_to_rownames(., var = "rowname"),
    set_rownames(data.frame("-", "-", "-", "-"), "Compared to 2_Months_post_MDA") %>%
      setNames(., colnames(Tab18$table)),
    Tab20$table[rownames(Tab20$table) %like% "7" | rownames(Tab20$table) %like% "18",] %>%
    rownames_to_column(.) %>%
      set_rownames(.,c(2,1)) %>%
      .[order(row.names(.)), ] %>%
      remove_rownames(.) %>%
      column_to_rownames(., var = "rowname"))
```

In conclusion, both, AP only and AP+PMQ~LD~ MDA, were equivalently effective in significantly reducing parasitemia prevalence in general as much as the prevalence of gametocytes, the infective stage of *Plasmodium* parasites to naive mosquito vectors, in the blood of children <10 years of age and kept these prevalences significantly low until the end of our measuring period (18 months post-MDA).

# Comments about the statistical analysis {-}

## Declaration of unbiased analysis {-}

All statistical analyses presented here were focused toward answering specific scientific questions that had been posted by the researcher and were executed without prior in-depth knowledge of the study nor with knowledge of the researchers' conclusion to avoid any bias. Statistical outcomes were only compared back to the researchers' findings in the field post-analyses.

## Notes about R {-}

The statistical analysis was conducted in RStudio (2022.07.1+554) [@RStudio], using R version 4.2.2 [@Rcore]. The following R packages were required for the execution of the script: AER [@AER], data.table [@data.table], emmeans [@emmeans], ggpubr [@ggpubr], Hmisc [@Hmisc], janitor [@janitor], jtools [@jtools], magrittr [@magrittr], stringr [@stringr], tidyverse [@tidyverse], xlsx [@xlsx]. The appendix was written in Rmarkdown [@rmarkdown] with support of the bookdown [@bookdown] and tinytex [@tinytex] packages for reference implementation.
